EARS形式の要件定義書と設計書をArtifactに表示します。

```markdown
# ニューロシンボリックAI統合システム - 要件定義書
## MUSUBI × YATA統合プロジェクト

**文書ID**: REQ-NSAI-001  
**バージョン**: 1.0  
**作成日**: 2026-01-01  
**承認者**: プロジェクトオーナー  
**ステータス**: Draft

---

## 1. 文書概要

### 1.1 目的
本文書は、MUSUBIとYATAを統合したニューロシンボリックAI Codingシステムの要件を、EARS（Easy Approach to Requirements Syntax）形式で定義する。

### 1.2 スコープ
- ニューロシンボリック統合レイヤー
- 要求分析強化機能
- 設計生成強化機能
- コード生成・検証機能
- 説明生成機能
- トレーサビリティ管理

### 1.3 EARS パターン凡例
- **UBIQUITOUS**: システムが常に満たすべき要件
- **EVENT-DRIVEN**: 特定のイベント発生時の要件
- **STATE-DRIVEN**: 特定の状態における要件
- **UNWANTED**: 回避すべき動作の要件
- **OPTIONAL**: 条件付き要件

---

## 2. 統合レイヤー要件

### REQ-INT-001: ニューロシンボリック統合
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL MUSUBIのLLMエージェントとYATAの知識グラフを統合し、  
AND THE システム SHALL ニューラル推論とシンボリック推論の結果を組み合わせ、  
AND THE システム SHALL 両者の信頼度を評価して最終結果を生成する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- MUSUBIエージェントとYATA MCPサーバーが正常に通信できる
- ニューラル・シンボリック双方の結果が取得できる
- 信頼度評価アルゴリズムが動作する

---

### REQ-INT-002: 信頼度評価
**種別**: UBIQUITOUS

**要件**:  
WHILE 推論結果を統合する際,  
THE システム SHALL ニューラル推論の信頼度を0.0-1.0で算出し、  
AND THE システム SHALL シンボリック推論の検証結果（valid/invalid）を取得し、  
AND THE システム SHALL 以下のルールで最終結果を決定する:
- シンボリック推論がinvalidの場合、ニューラル結果を棄却
- シンボリック推論がvalidかつニューラル信頼度≥0.8の場合、ニューラル結果を採用
- 上記以外の場合、シンボリック結果を優先

**検証方法**: ユニットテスト、統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 信頼度計算が正確に動作する
- 決定ルールが仕様通りに実装されている
- テストケースで95%以上の正答率

---

### REQ-INT-003: 矛盾検出
**種別**: EVENT-DRIVEN

**要件**:  
WHEN ニューラル推論とシンボリック推論の結果が矛盾する場合,  
THE システム SHALL 矛盾箇所を特定し、  
AND THE システム SHALL 矛盾の種類（論理的、制約違反、パターン不一致等）を分類し、  
AND THE システム SHALL 矛盾解消の提案をユーザーに提示する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 矛盾が100%検出される
- 矛盾の種類が正確に分類される
- 解消提案が生成される

---

## 3. 要求分析要件

### REQ-RA-001: EARS形式検証
**種別**: EVENT-DRIVEN

**要件**:  
WHEN ユーザーが自然言語で要求を入力した場合,  
THE システム SHALL LLMを使用してEARS形式の要件に変換し、  
AND THE システム SHALL EARS構文の妥当性を検証し（5パターン準拠）、  
AND THE システム SHALL 構文エラーがある場合は修正案を提示する。

**検証方法**: ユニットテスト、E2Eテスト  
**優先度**: P0（必須）  
**受入基準**:
- EARS 5パターンすべてに対応
- 構文検証精度95%以上
- 修正提案の妥当性をエキスパートが確認

---

### REQ-RA-002: オントロジー検証
**種別**: EVENT-DRIVEN

**要件**:  
WHEN EARS形式の要件が生成された場合,  
THE システム SHALL 要件をオントロジーにマッピングし、  
AND THE システム SHALL 論理的一貫性を検証し、  
AND THE システム SHALL 既存要件との矛盾を検出し、  
AND THE システム SHALL 検証結果をレポート形式で出力する。

**検証方法**: 統合テスト、オントロジー推論エンジンテスト  
**優先度**: P0（必須）  
**受入基準**:
- オントロジーマッピング成功率100%
- 矛盾検出精度95%以上
- 検証レポートが生成される

---

### REQ-RA-003: 関連要件検索
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 新しい要件が追加される場合,  
THE システム SHALL YATA知識グラフを使用して関連する既存要件を検索し、  
AND THE システム SHALL 関連度スコアを算出し（0.0-1.0）、  
AND THE システム SHALL 関連度が0.7以上の要件をリストアップする。

**検証方法**: 統合テスト  
**優先度**: P1（重要）  
**受入基準**:
- 関連要件が適切に検索される
- 関連度スコアが妥当（専門家評価）
- 検索時間が5秒以内

---

### REQ-RA-004: 要件分解
**種別**: OPTIONAL

**要件**:  
IF ユーザーが要件分解を要求した場合,  
THEN THE システム SHALL 複雑な要件をサブ要件に分解し、  
AND THE システム SHALL 各サブ要件にIDを付与し、  
AND THE システム SHALL 親子関係をグラフで記録する。

**検証方法**: E2Eテスト  
**優先度**: P2（任意）  
**受入基準**:
- 分解ロジックが適切に動作
- 親子関係が正しく記録される

---

## 4. 設計生成要件

### REQ-DES-001: パターン検出
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 設計生成が要求された場合,  
THE システム SHALL YATA知識グラフを使用して適用可能なデザインパターンを検出し、  
AND THE システム SHALL 各パターンの適用可能性スコア（0.0-1.0）を算出し、  
AND THE システム SHALL スコアが0.8以上のパターンを推奨する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 10種類のパターンを検出可能
- パターン検出精度90%以上
- スコア計算が妥当

---

### REQ-DES-002: フレームワーク最適化
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 特定のフレームワークが指定された場合,  
THE システム SHALL YATAの26フレームワーク知識を参照し、  
AND THE システム SHALL フレームワークのベストプラクティスを適用し、  
AND THE システム SHALL 推奨される設計パターンをコード例と共に提示する。

**検証方法**: E2Eテスト  
**優先度**: P0（必須）  
**受入基準**:
- 26フレームワークすべてに対応
- ベストプラクティス適用率90%以上
- コード例が実行可能

---

### REQ-DES-003: SOLID原則検証
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 設計が生成された場合,  
THE システム SHALL SOLID原則への準拠を検証し、  
AND THE システム SHALL 違反箇所を特定し、  
AND THE システム SHALL 修正案を生成する。

**検証方法**: ユニットテスト、静的解析  
**優先度**: P0（必須）  
**受入基準**:
- SOLID 5原則すべてを検証
- 違反検出精度95%以上
- 修正案の妥当性

---

### REQ-DES-004: C4モデル生成
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 設計が確定した場合,  
THE システム SHALL C4モデル（Context, Container, Component, Code）を自動生成し、  
AND THE システム SHALL PlantUML形式で出力し、  
AND THE システム SHALL 要件とのトレーサビリティリンクを埋め込む。

**検証方法**: 統合テスト  
**優先度**: P1（重要）  
**受入基準**:
- 4レベルすべてのダイアグラム生成
- PlantUML構文が正確
- トレーサビリティIDが正しい

---

### REQ-DES-005: アーキテクチャ決定記録（ADR）
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 重要な設計決定が行われた場合,  
THE システム SHALL ADRを自動生成し、  
AND THE システム SHALL 決定の背景、選択肢、理由を記録し、  
AND THE システム SHALL Markdown形式で保存する。

**検証方法**: E2Eテスト  
**優先度**: P1（重要）  
**受入基準**:
- ADRフォーマット準拠
- 決定理由が明確に記載
- ファイルが正しく保存される

---

## 5. コード生成・検証要件

### REQ-COD-001: コード生成
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 設計からコード生成が要求された場合,  
THE システム SHALL LLMを使用してコードを生成し、  
AND THE システム SHALL 生成されたコードをYATAで解析し、  
AND THE システム SHALL 設計との整合性を検証する。

**検証方法**: E2Eテスト  
**優先度**: P0（必須）  
**受入基準**:
- コード生成成功率95%以上
- 構文エラー率5%以下
- 設計整合性95%以上

---

### REQ-COD-002: 静的解析
**種別**: EVENT-DRIVEN

**要件**:  
WHEN コードが生成された場合,  
THE システム SHALL Tree-sitterを使用してASTを解析し、  
AND THE システム SHALL コード品質メトリクスを算出し（複雑度、重複等）、  
AND THE システム SHALL 品質基準を満たさない場合は警告を発する。

**検証方法**: ユニットテスト  
**優先度**: P0（必須）  
**受入基準**:
- AST解析成功率100%
- メトリクス計算が正確
- 品質基準が適切

---

### REQ-COD-003: デザインパターン適合性
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 設計でデザインパターンが指定された場合,  
THE システム SHALL 生成コードがパターンに準拠しているか検証し、  
AND THE システム SHALL 準拠していない場合は修正を試み、  
AND THE システム SHALL 3回の試行後も準拠しない場合はエラーを報告する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- パターン準拠検証精度90%以上
- 自動修正成功率80%以上
- エラーレポートが詳細

---

### REQ-COD-004: 依存関係検証
**種別**: EVENT-DRIVEN

**要件**:  
WHEN コードが生成された場合,  
THE システム SHALL YATA知識グラフで依存関係を解析し、  
AND THE システム SHALL 循環依存を検出し、  
AND THE システム SHALL 未解決の依存を特定する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 循環依存検出率100%
- 未解決依存の特定精度95%以上

---

### REQ-COD-005: コーディング規約検証
**種別**: UBIQUITOUS

**要件**:  
WHILE コードが生成される際,  
THE システム SHALL プロジェクト固有のコーディング規約を適用し、  
AND THE システム SHALL 命名規則、インデント、コメント等を検証し、  
AND THE システム SHALL 違反箇所を自動修正する。

**検証方法**: ユニットテスト  
**優先度**: P1（重要）  
**受入基準**:
- 規約違反検出率95%以上
- 自動修正成功率90%以上

---

### REQ-COD-006: セキュリティ検証
**種別**: UNWANTED

**要件**:  
THE システム SHALL 以下のセキュリティ脆弱性を含むコードを生成してはならない:
- SQLインジェクション
- クロスサイトスクリプティング（XSS）
- ハードコードされた認証情報
- 安全でない暗号化アルゴリズム
- パストラバーサル

AND IF 脆弱性が検出された場合,  
THEN THE システム SHALL コード生成を中止し、  
AND THE システム SHALL 脆弱性詳細をレポートする。

**検証方法**: セキュリティテスト、SAST統合  
**優先度**: P0（必須）  
**受入基準**:
- 主要脆弱性の検出率98%以上
- 誤検出率10%以下
- レポートが詳細

---

## 6. テスト生成要件

### REQ-TST-001: ユニットテスト生成
**種別**: EVENT-DRIVEN

**要件**:  
WHEN コードが生成された場合,  
THE システム SHALL 各関数/メソッドに対してユニットテストを生成し、  
AND THE システム SHALL EARS要件とマッピングし、  
AND THE システム SHALL カバレッジ80%以上を目標とする。

**検証方法**: E2Eテスト、カバレッジ測定  
**優先度**: P0（必須）  
**受入基準**:
- テスト生成成功率90%以上
- カバレッジ目標達成率85%以上
- 要件マッピング100%

---

### REQ-TST-002: 統合テスト生成
**種別**: OPTIONAL

**要件**:  
IF ユーザーが統合テスト生成を要求した場合,  
THEN THE システム SHALL コンポーネント間の相互作用をテストするコードを生成し、  
AND THE システム SHALL モックを使用せず実際のサービスを利用し、  
AND THE システム SHALL シナリオベースのテストケースを作成する。

**検証方法**: E2Eテスト  
**優先度**: P1（重要）  
**受入基準**:
- 統合テストが実行可能
- 実サービス利用
- シナリオが要件に準拠

---

## 7. 説明生成要件

### REQ-EXP-001: 推論チェーン記録
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが要求から設計、コード生成を行う際,  
THE システム SHALL すべての推論ステップを記録し、  
AND THE システム SHALL ニューラル・シンボリック双方の判断根拠を保存し、  
AND THE システム SHALL 時系列順に構造化されたログを生成する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 推論ステップ記録率100%
- ログ構造が適切
- 時系列が正確

---

### REQ-EXP-002: 自然言語説明生成
**種別**: EVENT-DRIVEN

**要件**:  
WHEN ユーザーが説明を要求した場合,  
THE システム SHALL 推論チェーンから自然言語の説明を生成し、  
AND THE システム SHALL 以下を含む:
- なぜその要件が必要か
- なぜその設計を選択したか
- どのパターンを適用したか
- どの制約を満たしているか

**検証方法**: E2Eテスト、ユーザー評価  
**優先度**: P0（必須）  
**受入基準**:
- 説明生成成功率95%以上
- 説明の分かりやすさ（ユーザー評価4.0/5.0以上）

---

### REQ-EXP-003: ビジュアル説明
**種別**: OPTIONAL

**要件**:  
IF ユーザーがビジュアル説明を要求した場合,  
THEN THE システム SHALL 推論グラフをGraphvizで可視化し、  
AND THE システム SHALL ノード（決定点）とエッジ（推論）を表示し、  
AND THE システム SHALL インタラクティブに探索可能にする。

**検証方法**: E2Eテスト  
**優先度**: P2（任意）  
**受入基準**:
- グラフが正しく生成される
- インタラクティブ機能が動作

---

## 8. トレーサビリティ要件

### REQ-TRA-001: 完全トレーサビリティ
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL 要求↔設計↔コード↔テストの完全な双方向トレーサビリティを維持し、  
AND THE システム SHALL トレーサビリティマトリクスを自動生成し、  
AND THE システム SHALL カバレッジ100%を保証する。

**検証方法**: トレーサビリティ監査  
**優先度**: P0（必須）  
**受入基準**:
- トレーサビリティマトリクス生成成功
- カバレッジ100%達成
- リンク切れ0件

---

### REQ-TRA-002: 影響分析
**種別**: EVENT-DRIVEN

**要件**:  
WHEN 要求が変更された場合,  
THE システム SHALL 影響を受ける設計・コード・テストを特定し、  
AND THE システム SHALL 影響範囲をレポートし、  
AND THE システム SHALL 変更推奨事項を提示する。

**検証方法**: 統合テスト  
**優先度**: P0（必須）  
**受入基準**:
- 影響範囲特定精度95%以上
- レポート生成成功率100%

---

## 9. パフォーマンス要件

### REQ-PER-001: 応答時間
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL 以下の応答時間を満たす:
- 要求分析: 10秒以内
- 設計生成: 30秒以内
- コード生成: 60秒以内
- 説明生成: 5秒以内

**検証方法**: パフォーマンステスト  
**優先度**: P1（重要）  
**受入基準**:
- 95%のリクエストが目標時間内に完了

---

### REQ-PER-002: スケーラビリティ
**種別**: STATE-DRIVEN

**要件**:  
WHILE 同時ユーザー数が100人以下の場合,  
THE システム SHALL すべてのリクエストを処理し、  
AND THE システム SHALL 応答時間の劣化を20%以内に抑える。

**検証方法**: 負荷テスト  
**優先度**: P1（重要）  
**受入基準**:
- 100同時ユーザーで安定動作
- 応答時間劣化20%以内

---

## 10. 品質要件

### REQ-QUA-001: コード品質
**種別**: UBIQUITOUS

**要件**:  
WHILE コードが生成される際,  
THE システム SHALL 以下の品質メトリクスを満たす:
- サイクロマティック複雑度: 10以下
- 関数の行数: 50行以下
- クラスの行数: 300行以下
- 重複コード: 5%以下

**検証方法**: 静的解析  
**優先度**: P0（必須）  
**受入基準**:
- 90%のコードがメトリクスを満たす

---

### REQ-QUA-002: テストカバレッジ
**種別**: UBIQUITOUS

**要件**:  
WHILE テストが実行される際,  
THE システム SHALL 以下のカバレッジを達成する:
- ライン カバレッジ: 80%以上
- ブランチ カバレッジ: 75%以上
- 関数 カバレッジ: 90%以上

**検証方法**: カバレッジ測定  
**優先度**: P0（必須）  
**受入基準**:
- カバレッジ目標達成

---

## 11. セキュリティ要件

### REQ-SEC-001: データ保護
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL すべてのコードとデータをローカルで処理し、  
AND THE システム SHALL 外部への送信を行わず、  
AND THE システム SHALL ユーザーデータを暗号化して保存する。

**検証方法**: セキュリティ監査  
**優先度**: P0（必須）  
**受入基準**:
- 外部通信0件（LLM API除く）
- データ暗号化100%

---

### REQ-SEC-002: 認証・認可
**種別**: STATE-DRIVEN

**要件**:  
WHILE マルチユーザー環境で動作する場合,  
THE システム SHALL ユーザー認証を要求し、  
AND THE システム SHALL ロールベースのアクセス制御を実装し、  
AND THE システム SHALL 監査ログを記録する。

**検証方法**: セキュリティテスト  
**優先度**: P1（重要）  
**受入基準**:
- 認証100%成功
- 権限エラー0件
- 監査ログ完全

---

## 12. 統合・互換性要件

### REQ-INT-101: AIプラットフォーム対応
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL 以下の7つのAIプラットフォームをサポートする:
- Claude Code
- GitHub Copilot
- Cursor
- Gemini CLI
- Codex CLI
- Qwen Code
- Windsurf

**検証方法**: 統合テスト（各プラットフォーム）  
**優先度**: P0（必須）  
**受入基準**:
- 7プラットフォームすべてで動作
- 機能差異を文書化

---

### REQ-INT-102: MCP準拠
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL Model Context Protocol（MCP）に準拠し、  
AND THE システム SHALL stdio/SSE両方のトランスポートをサポートし、  
AND THE システム SHALL Tools/Prompts/Resourcesを提供する。

**検証方法**: MCP準拠テスト  
**優先度**: P0（必須）  
**受入基準**:
- MCP仕様100%準拠
- 両トランスポート動作

---

## 13. 保守性要件

### REQ-MNT-001: ログ記録
**種別**: UBIQUITOUS

**要件**:  
WHILE システムが稼働中,  
THE システム SHALL すべての重要な操作をログに記録し、  
AND THE システム SHALL ログレベル（DEBUG, INFO, WARN, ERROR）を適切に設定し、  
AND THE システム SHALL 構造化ログ（JSON）で出力する。

**検証方法**: ログ監査  
**優先度**: P1（重要）  
**受入基準**:
- 重要操作100%記録
- ログ形式が適切

---

### REQ-MNT-002: エラーハンドリング
**種別**: EVENT-DRIVEN

**要件**:  
WHEN エラーが発生した場合,  
THE システム SHALL エラーを適切にキャッチし、  
AND THE システム SHALL ユーザーフレンドリーなメッセージを表示し、  
AND THE システム SHALL 詳細なスタックトレースをログに記録し、  
AND THE システム SHALL 可能な場合は自動リカバリを試みる。

**検証方法**: エラーテスト  
**優先度**: P0（必須）  
**受入基準**:
- エラーキャッチ率100%
- リカバリ成功率80%以上

---

## 14. 要件トレーサビリティマトリクス（サンプル）

| 要件ID | 設計コンポーネント | テストケース | 優先度 |
|--------|------------------|-------------|--------|
| REQ-INT-001 | NeuroSymbolicIntegrator | TEST-INT-001-001 | P0 |
| REQ-RA-001 | RequirementsAnalyzer | TEST-RA-001-001 | P0 |
| REQ-DES-001 | PatternDetector | TEST-DES-001-001 | P0 |
| REQ-COD-001 | CodeGenerator | TEST-COD-001-001 | P0 |
| REQ-EXP-001 | ExplanationGenerator | TEST-EXP-001-001 | P0 |

---

## 15. 承認

| 役割 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| プロダクトオーナー | | | |
| リードアーキテクト | | | |
| QAリード | | | |

