# MUSUBIX 記号的推論・形式検証・Constitution強制 要件定義書

**文書ID**: REQ-SYMB-001  
**プロジェクト**: MUSUBIX  
**バージョン**: 1.1  
**作成日**: 2026-01-05  
**更新日**: 2026-01-05  
**ステータス**: Reviewed  
**準拠規格**: EARS（Easy Approach to Requirements Syntax）  
**関連文書**: MUSUBI-enhancement_roadmap_20260105.md, TSK-SYMB-001 v0.1

---

## 1. 概要

### 1.1 目的

MUSUBIXに以下の3つの機能を追加し、Neuro-Symbolic統合を深化させる：

1. **記号的推論強化**: LLM生成結果のセマンティックフィルタリング
2. **形式検証統合**: EARS要件からの検証条件生成とSMTソルバーによる検証
3. **Constitution強制エンジン**: 9条憲法の実行可能な形式ルール化

### 1.2 背景

ロードマップ分析により、MUSUBIXの現状評価：

| 評価項目 | 現状レベル | 目標レベル |
|---------|-----------|-----------|
| 記号的推論 | ★★★★☆ | ★★★★★ |
| 形式検証統合 | ★★☆☆☆ | ★★★★☆ |
| LLM生成検証 | ★★★☆☆ | ★★★★★ |

### 1.3 スコープ

- セマンティックコードフィルター機能（REQ-SF-001〜003）
- 形式検証エンジン（Z3統合）（REQ-FV-001〜005）
- EARS→形式仕様変換
- Constitution強制エンジン（全9条対応）（REQ-CONST-001〜010）
- 信頼度ベースルーティング（REQ-ROUTE-001〜003）
- 非機能要件（REQ-NFR-001〜006）

### 1.4 要件サマリー

| カテゴリ | 要件数 | P0 | P1 |
|---------|-------|----|----|
| セマンティックフィルター | 3 | 2 | 1 |
| 形式検証 | 5 | 4 | 1 |
| Constitution強制 | 10 | 8 | 2 |
| 信頼度ルーティング | 3 | 2 | 1 |
| 非機能要件 | 6 | 3 | 3 |
| **合計** | **27** | **19** | **8** |

### 1.5 優先度定義

| 優先度 | 説明 |
|--------|------|
| **P0** | 必須 - リリースに必要 |
| **P1** | 重要 - できる限り実装 |
| **P2** | 任意 - 時間があれば実装 |

### 1.6 関連要件との整合性

本要件定義は以下の既存要件と整合を取っています：

| 関連要件 | 整合内容 |
|---------|---------|
| **REQ-INT-002** | 信頼度閾値0.8を統一採用 |
| **REQ-ARC-001** | Library-First構成との整合 |
| **REQ-ARC-002** | CLI Interface Mandateとの整合 |

---

## 2. セマンティックコードフィルター要件

### REQ-SF-001: LLM生成コードフィルタリング

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN LLMがコードを生成した時,
THE システム SHALL 生成コードを記号ルールでフィルタリングし,
AND THE システム SHALL EARS要件との整合性を検証し,
AND THE システム SHALL Constitution条項との準拠性を検証し,
AND THE システム SHALL フィルタリング結果（accepted/rejected）と理由を返却する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 生成コードがフィルタリングパイプラインを通過する
- [ ] EARS要件との整合性が自動検証される
- [ ] Constitution違反が検出される
- [ ] 拒否理由が具体的に説明される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-001, TSK-SYMB-008  
**憲法準拠**: Article IV（EARS Format）, Article V（Traceability）

---

### REQ-SF-002: ハルシネーション検出

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN LLM生成コードを検証する時,
THE システム SHALL 存在しないAPI・関数・モジュールの参照を検出し,
AND THE システム SHALL プロジェクトコンテキストと照合して不整合を識別し,
AND THE システム SHALL 検出されたハルシネーションの修正提案を生成する。
```

**検証方法**: ユニットテスト、ベンチマークテスト  
**受入基準**:
- [ ] 存在しないAPIの参照が95%以上の精度で検出される
- [ ] YATAの知識グラフと照合して検証される
- [ ] 修正提案が実用的なものである

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-002

---

### REQ-SF-003: 複数候補ランキング

**種別**: OPTIONAL  
**優先度**: P1（重要）

**要件**:  
```text
IF LLMが複数のコード候補を生成した場合,
THEN THE システム SHALL 品質メトリクス（複雑度、保守性、要件カバレッジ）でランキングし,
AND THE システム SHALL 各候補のスコア内訳を提供し,
AND THE システム SHALL 最高スコア候補を推奨する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] 複数候補がスコアでランキングされる
- [ ] スコア計算が透明で説明可能
- [ ] ランキング結果がユーザーに提示される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-014

---

## 3. 形式検証統合要件

### REQ-FV-001: EARS→形式仕様変換

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN EARS形式の要件が入力された時,
THE システム SHALL EARS文をパースして構造化表現に変換し,
AND THE システム SHALL 構造化表現から検証条件（VC: Verification Condition）を生成し,
AND THE システム SHALL 検証条件をSMT-LIB形式で出力する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 5種類のEARSパターンすべてがパース可能
- [ ] 検証条件が正しく生成される
- [ ] SMT-LIB形式の出力が有効

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-009, TSK-SYMB-012  
**憲法準拠**: Article IV（EARS Format）

**変換例**:

```typescript
// 入力: EARS形式
"WHEN user clicks login button, THE system SHALL authenticate user within 3 seconds"

// 出力: 構造化表現
{
  type: "EVENT-DRIVEN",
  trigger: { event: "user.click", target: "login_button" },
  postcondition: {
    action: "system.authenticate",
    constraint: { type: "temporal", operator: "<=", value: 3, unit: "seconds" }
  }
}

// 出力: SMT-LIB
(assert (=> (click login_button) (and (authenticate) (<= response_time 3000))))
```

---

### REQ-FV-002: 事前条件検証

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN コードと事前条件が入力された時,
THE システム SHALL Z3ソルバーを使用して事前条件を検証し,
AND THE システム SHALL 検証結果（valid/invalid）を返却し,
AND THE システム SHALL 違反時は反例（counterexample）を生成する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] Z3ソルバーが正常に動作する
- [ ] 事前条件違反が検出される
- [ ] 反例が具体的な入力値として提示される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-011, TSK-SYMB-012

---

### REQ-FV-003: 事後条件検証

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN コードと事後条件が入力された時,
THE システム SHALL 事後条件の充足可能性をZ3で検証し,
AND THE システム SHALL 検証成功時は証明（proof）を生成し,
AND THE システム SHALL 検証失敗時は修正提案を生成する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 事後条件の検証が動作する
- [ ] 証明成功時のドキュメントが生成される
- [ ] 失敗時の修正提案が実用的

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-011, TSK-SYMB-012

---

### REQ-FV-004: 不変条件検証

**種別**: EVENT-DRIVEN  
**優先度**: P1（重要）

**要件**:  
```text
WHEN コードとループ/クラス不変条件が入力された時,
THE システム SHALL 不変条件が維持されることを検証し,
AND THE システム SHALL 違反箇所（Location）を特定し,
AND THE システム SHALL 違反理由を説明する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] ループ不変条件の検証が動作する
- [ ] クラス不変条件の検証が動作する
- [ ] 違反箇所が正確に特定される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-011

---

### REQ-FV-005: 検証条件自動生成

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN コードとEARS仕様が入力された時,
THE システム SHALL コードから検証条件（VC）を自動生成し,
AND THE システム SHALL VCをEARS要件にマッピングし,
AND THE システム SHALL 検証カバレッジを算出する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] VCが自動生成される
- [ ] EARS要件とのマッピングが正確
- [ ] カバレッジが100%を目標

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-010

---

## 4. Constitution強制エンジン要件

### REQ-CONST-001: Constitution実行可能ルール化

**種別**: UBIQUITOUS  
**優先度**: P0（必須）

**要件**:  
```text
WHILE システムが稼働中,
THE システム SHALL 9条憲法を実行可能な形式ルールとして保持し,
AND THE システム SHALL 各ルールに対してpredicate関数を定義し,
AND THE システム SHALL enforcement方針（block/warn/log）を設定する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] 9条すべてがルールとして実装されている
- [ ] predicate関数が検証可能
- [ ] enforcement方針が設定されている

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-003, TSK-SYMB-016  
**憲法準拠**: 全9条

**ルール定義例**:

```typescript
export interface ConstitutionRule {
  article: number;        // 1-9
  name: string;           // "Library-First Principle"
  predicate: (change: CodeChange) => Promise<boolean>;
  enforcement: 'block' | 'warn' | 'log';
  message: string;
}
```

---

### REQ-CONST-002: Article I検証（Library-First）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN 新しい機能コードが追加された時,
THE システム SHALL コードが独立ライブラリとして実装されているか検証し,
AND THE システム SHALL ライブラリが独自のテストスイートを持つか検証し,
AND THE システム SHALL アプリケーションコードへの依存がないか検証する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] ライブラリ構造が検出される
- [ ] テストスイートの存在が確認される
- [ ] 依存関係が解析される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004  
**憲法準拠**: Article I

---

### REQ-CONST-003: Article III検証（Test-First）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN コード変更がコミットされる時,
THE システム SHALL テストカバレッジを計算し,
AND THE システム SHALL カバレッジが80%未満の場合は警告を発し,
AND THE システム SHALL EARS要件に対応するテストの存在を確認する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] テストカバレッジが自動計算される
- [ ] 80%閾値による警告が動作する
- [ ] 要件とテストのマッピングが検証される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004  
**憲法準拠**: Article III

---

### REQ-CONST-004: Article V検証（Traceability）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN コード変更が発生した時,
THE システム SHALL 要件↔コードのトレーサビリティを検証し,
AND THE システム SHALL トレーサビリティカバレッジを計算し,
AND THE システム SHALL 100%未満の場合は変更をブロックする。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] トレーサビリティリンクが検出される
- [ ] カバレッジが正確に計算される
- [ ] ブロック機能が動作する

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-019  
**憲法準拠**: Article V

---

### REQ-CONST-005: Constitution違反レポート

**種別**: EVENT-DRIVEN  
**優先度**: P1（重要）

**要件**:  
```text
WHEN Constitution違反が検出された時,
THE システム SHALL 違反の詳細レポートを生成し,
AND THE システム SHALL 違反箇所と修正提案を提示し,
AND THE システム SHALL 違反履歴をログに記録する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] 違反レポートが生成される
- [ ] 修正提案が具体的
- [ ] 履歴が永続化される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-003

---

### REQ-CONST-006: Article II検証（CLI Interface）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN 新しいライブラリが追加された時,
THE システム SHALL ライブラリがCLIインターフェースを公開しているか検証し,
AND THE システム SHALL `--help`フラグが実装されているか検証し,
AND THE システム SHALL 終了コード規約（0=成功、非0=エラー）に準拠しているか検証する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] CLIエントリポイントの存在が確認される
- [ ] `--help`の実装が検証される
- [ ] 終了コードが規約に準拠

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-008, TSK-SYMB-012  
**憲法準拠**: Article II

---

### REQ-CONST-007: Article VI検証（Project Memory）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN 設計決定が行われる時,
THE システム SHALL steering/ディレクトリが参照されたことを検証し,
AND THE システム SHALL 決定がProject Memoryに記録されることを検証し,
AND THE システム SHALL 過去の決定との整合性を検証する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] steering/参照の証跡が確認される
- [ ] 決定がProject Memoryに記録される
- [ ] 過去決定との矛盾が検出される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004  
**憲法準拠**: Article VI

---

### REQ-CONST-008: Article VII検証（Simplicity Gate）

**種別**: EVENT-DRIVEN  
**優先度**: P1（重要）

**要件**:  
```text
WHEN 新しいプロジェクト（例: `virtual-projects/` 配下）が追加される時,
THE システム SHALL 初期構成のプロジェクト数が最大3プロジェクト以内であることを検証し,
AND THE システム SHALL 上限を超える場合はPhase -1 Gateの承認記録が存在することを検証し,
AND THE システム SHALL 上限超過かつ承認記録がない場合は変更をブロックする。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] プロジェクト数が自動算出される
- [ ] 3プロジェクト上限が検証される
- [ ] 上限超過時に承認記録の有無が検証される
- [ ] 上限超過かつ承認なしの場合にブロックされる

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004  
**憲法準拠**: Article VII

---

### REQ-CONST-009: Article VIII検証（Anti-Abstraction Gate）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN フレームワーク/基盤ライブラリのAPIに対するラッパ（不要な抽象化レイヤー）が追加される時,
THE システム SHALL フレームワークAPIを直接利用していることを検証し,
AND THE システム SHALL ラッパ追加が不可避な例外である場合はPhase -1 Gateの承認記録が存在することを検証し,
AND THE システム SHALL 不要なラッパ抽象化が追加された場合は変更をブロックする。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] フレームワークAPIに対するラッパ導入が検出される
- [ ] 直接利用（ラッパ不使用）が検証される
- [ ] 例外時に承認記録の有無が検証される
- [ ] 不要なラッパ抽象化の追加がブロックされる

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004  
**憲法準拠**: Article VIII

---

### REQ-CONST-010: Article IX検証（Integration-First Testing）

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN テスト（ユニット/統合）が追加または更新される時,
THE システム SHALL 統合テストが実サービスを優先していることを検証し,
AND THE システム SHALL モック/スタブを使用する場合は例外理由と承認記録が存在することを検証し,
AND THE システム SHALL 例外理由または承認記録がないモック使用を検出した場合は変更をブロックする。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 統合テストの存在が検出される
- [ ] 実サービス優先の方針が検証される
- [ ] モック使用時の例外理由と承認記録が検証される
- [ ] 承認なしのモック使用がブロックされる

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-004, TSK-SYMB-019  
**憲法準拠**: Article IX

---

## 5. 信頼度ベースルーティング要件

### REQ-ROUTE-001: 信頼度推定

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN LLM出力が生成された時,
THE システム SHALL 出力の信頼度を0.0-1.0で推定し,
AND THE システム SHALL 信頼度を4つの観点（構文、意味、事実、一貫性）で分解し,
AND THE システム SHALL リスク要因を識別する。
```

**検証方法**: ユニットテスト、ベンチマークテスト  
**受入基準**:
- [ ] 信頼度が0.0-1.0の範囲で算出される
- [ ] 4観点の分解スコアが提供される
- [ ] リスク要因が識別される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-005

**信頼度分解**:

```typescript
interface ConfidenceBreakdown {
  syntactic: number;    // 構文的正しさ
  semantic: number;     // 意味的正しさ
  factual: number;      // 事実的正確さ（API存在等）
  consistency: number;  // 文脈との一貫性
}
```

---

### REQ-ROUTE-002: ルーティング決定

**種別**: EVENT-DRIVEN  
**優先度**: P0（必須）

**要件**:  
```text
WHEN 信頼度が算出された時,
THE システム SHALL 以下のルールでルーティングを決定する:
```

| 信頼度範囲 | ルーティング決定 | アクション |
|-----------|----------------|-----------|
| ≥ 0.8 | accept | そのまま採用（REQ-INT-002準拠） |
| 0.5 - 0.8 | symbolic_verify | 記号検証を実行 |
| < 0.5 | symbolic_regenerate | 記号的に再生成 |

> 💡 閾値0.8はREQ-INT-002（信頼度評価）と整合。シンボリック検証がvalidの場合のみ適用される。

```text
AND THE システム SHALL ルーティング理由を説明する。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 閾値ベースのルーティングが動作する
- [ ] 記号検証への委譲が正常に動作する
- [ ] ルーティング理由が記録される

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-006, TSK-SYMB-008

---

### REQ-ROUTE-003: 結果ブレンド

**種別**: OPTIONAL  
**優先度**: P1（重要）

**要件**:  
```text
IF ニューラル結果と記号結果の両方が存在する場合,
THEN THE システム SHALL 3つのブレンド戦略（neural_priority, symbolic_priority, confidence_weighted）から選択し,
AND THE システム SHALL ブレンド結果を生成し,
AND THE システム SHALL ソース帰属（neural: %, symbolic: %）を提供する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] 3つのブレンド戦略が実装されている
- [ ] ブレンド結果が適切に生成される
- [ ] ソース帰属が正確

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-015

---

## 6. 非機能要件

### REQ-NFR-001: パフォーマンス

**種別**: UBIQUITOUS  
**優先度**: P1（重要）

**要件**:  
```text
WHILE システムが形式検証を実行中,
THE システム SHALL 単一関数の検証を5秒以内に完了し,
AND THE システム SHALL タイムアウト時は部分結果を返却する。
```

**検証方法**: パフォーマンステスト  
**受入基準**:
- [ ] 95%のケースで5秒以内に完了
- [ ] タイムアウト処理が実装されている

---

### REQ-NFR-002: 拡張性

**種別**: UBIQUITOUS  
**優先度**: P1（重要）

**要件**:  
```text
WHILE システムが稼働中,
THE システム SHALL 新しいConstitution条項の追加を設定変更のみで可能とし,
AND THE システム SHALL 新しいフィルタールールの追加をYAML設定で可能とする。
```

**検証方法**: 設計レビュー  
**受入基準**:
- [ ] Constitution条項がプラグイン可能
- [ ] フィルタールールがYAML設定可能

---

### REQ-NFR-003: 説明可能性

**種別**: UBIQUITOUS  
**優先度**: P0（必須）

**要件**:  
```text
WHILE システムが検証・フィルタリングを実行する際,
THE システム SHALL すべての決定に対して説明を生成し,
AND THE システム SHALL 説明をユーザーに提示可能な形式で出力する。
```

**検証方法**: ユニットテスト  
**受入基準**:
- [ ] すべての決定に説明が付与される
- [ ] 説明が人間に理解可能

---

### REQ-NFR-004: エラーハンドリング

**種別**: UBIQUITOUS  
**優先度**: P0（必須）

**要件**:  
```text
WHILE システムが稼働中,
THE システム SHALL すべての外部サービス（Z3、YATA等）の障害を適切にハンドリングし,
AND THE システム SHALL エラー発生時は詳細なエラーメッセージとスタックトレースを提供し,
AND THE システム SHALL 部分的な結果が利用可能な場合はそれを返却する。
```

**検証方法**: ユニットテスト、障害注入テスト  
**受入基準**:
- [ ] Z3タイムアウト時のフォールバックが動作する
- [ ] YATA接続エラー時のgraceful degradationが動作する
- [ ] エラーメッセージが診断に十分な情報を含む
- [ ] 部分結果の返却が動作する

**エラーハンドリング戦略**:

```typescript
interface ErrorHandlingStrategy {
  z3Timeout: 'return_partial' | 'fallback_to_symbolic' | 'abort';
  yataConnectionError: 'retry' | 'use_cached' | 'degrade_gracefully';
  constitutionCheckError: 'log_and_continue' | 'block';
  maxRetries: number;
  retryDelayMs: number;
}
```

---

### REQ-NFR-005: セキュリティ

**種別**: UBIQUITOUS  
**優先度**: P0（必須）

**要件**:  
```text
WHILE システムが稼働中,
THE システム SHALL 入力されたコードをサンドボックス環境で検証し,
AND THE システム SHALL 機密情報（APIキー、パスワード等）を検出して警告し,
AND THE システム SHALL 検証結果・学習データを安全に保存し,
AND THE システム SHALL OWASP Top 10の脆弱性パターンをフィルタリングルールに含める。
```

**検証方法**: セキュリティテスト、ペネトレーションテスト  
**受入基準**:
- [ ] コード実行がサンドボックス内で行われる
- [ ] 機密情報の検出率が95%以上
- [ ] 保存データが暗号化されている
- [ ] OWASP Top 10パターンが検出される

**セキュリティチェック項目**:

| カテゴリ | チェック内容 |
|---------|-------------|
| 機密情報漏洩 | APIキー、パスワード、トークンの検出 |
| インジェクション | SQL、NoSQL、コマンドインジェクションパターン |
| 認証・認可 | 不適切な認証実装の検出 |
| データ保護 | 平文での機密データ保存 |
| ログ出力 | 機密情報のログ出力検出 |

**トレーサビリティ**: DES-SYMB-001, TSK-SYMB-013  
**憲法準拠**: Article V（Traceability）, Article VI（Project Memory - セキュリティ方針の記録）

---

### REQ-NFR-006: 監査ログ

**種別**: UBIQUITOUS  
**優先度**: P1（重要）

**要件**:  
```text
WHILE システムが稼働中,
THE システム SHALL すべてのConstitution検証結果を監査ログに記録し,
AND THE システム SHALL 監査ログに改ざん検出機能を持たせ,
AND THE システム SHALL ログの保持期間と自動アーカイブを設定可能とする。
```

**検証方法**: ユニットテスト、統合テスト  
**受入基準**:
- [ ] 全検証結果がログに記録される
- [ ] ログ改ざんが検出される
- [ ] アーカイブ機能が動作する

---

## 7. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│                    MUSUBIX Enhanced Architecture                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Semantic Code Filter                    │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────────────┐   │    │
│  │  │ Hallucin. │  │ EARS      │  │ Constitution      │   │    │
│  │  │ Detector  │  │ Validator │  │ Enforcer          │   │    │
│  │  └───────────┘  └───────────┘  └───────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │               Formal Verification Engine                 │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────────────┐   │    │
│  │  │ EARS→SMT  │  │ Z3 Solver │  │ Feedback Gen.     │   │    │
│  │  │ Converter │  │           │  │                   │   │    │
│  │  └───────────┘  └───────────┘  └───────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │            Confidence-Based Routing Engine               │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────────────┐   │    │
│  │  │ Confidence│  │ Router    │  │ Result Blender    │   │    │
│  │  │ Estimator │  │           │  │                   │   │    │
│  │  └───────────┘  └───────────┘  └───────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 実装ロードマップ

### Phase 1: 基盤強化（1-2週間）

| タスク | 優先度 | 関連要件 |
|-------|-------|---------|
| Semantic Code Filter基盤 | ★★★★★ | REQ-SF-001, 002 |
| Constitution強制エンジン（9条全対応） | ★★★★★ | REQ-CONST-001〜010 |
| 信頼度ルーティング | ★★★★☆ | REQ-ROUTE-001, 002 |
| エラーハンドリング基盤 | ★★★★☆ | REQ-NFR-004 |

### Phase 2: 形式検証統合（2-3週間）

| タスク | 優先度 | 関連要件 |
|-------|-------|---------|
| EARS→形式仕様変換 | ★★★★★ | REQ-FV-001 |
| Z3ソルバー統合 | ★★★★★ | REQ-FV-002, 003, 004 |
| 検証条件自動生成 | ★★★★☆ | REQ-FV-005 |
| セキュリティフィルター | ★★★★☆ | REQ-NFR-005 |

### Phase 3: 高度機能（3-4週間）

| タスク | 優先度 | 関連要件 |
|-------|-------|---------|
| 複数候補ランキング | ★★★☆☆ | REQ-SF-003 |
| 結果ブレンド | ★★★☆☆ | REQ-ROUTE-003 |
| 拡張性対応 | ★★★☆☆ | REQ-NFR-002 |
| 監査ログ | ★★★☆☆ | REQ-NFR-006 |

---

## 9. 用語定義

| 用語 | 定義 |
|------|------|
| **SMT** | Satisfiability Modulo Theories - 理論付き充足可能性問題 |
| **Z3** | Microsoft製のSMTソルバー |
| **VC** | Verification Condition - 検証条件 |
| **Predicate** | 真偽値を返す述語関数 |
| **Counterexample** | 仕様違反を示す反例 |
| **Hallucination** | LLMが生成する存在しない情報 |

---

## 10. 承認

| 役割 | 名前 | 日付 | 署名 |
|------|------|------|------|
| 要件定義者 | AI Agent | 2026-01-05 | ✓ |
| レビュアー | AI Agent | 2026-01-05 | ✓ |
| 承認者 | | | |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-05 | 初版作成 |
| 1.1 | 2026-01-05 | レビュー指摘対応：要件ID体系修正、Article II/VI-IX追加、閾値統一、エラーハンドリング・セキュリティ要件追加 |

---

**文書ID**: REQ-SYMB-001  
**バージョン**: 1.1  
**作成日**: 2026-01-05  
**更新日**: 2026-01-05  
**ステータス**: Reviewed
