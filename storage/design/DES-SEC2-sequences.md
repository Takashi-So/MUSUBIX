# MUSUBIX Security v2.0 動的設計書（シーケンス図）

**プロジェクト**: MUSUBIX Security Subsystem
**バージョン**: 2.0.0
**ステータス**: Draft
**作成日**: 2026-01-07
**関連ドキュメント**: 
- [コード設計書](DES-SEC2-code.md)
- [コンポーネント設計書](DES-SEC2-components.md)
- [アーキテクチャ設計書](DES-SEC2-architecture.md)

---

## 1. 主要ユースケースのシーケンス図

### 1.1 脆弱性スキャン（Full Scan）

**ユースケース**: 開発者がCLIを使ってプロジェクト全体の脆弱性スキャンを実行

**トレーサビリティ**: REQ-SEC2-CLI-001, REQ-SEC2-SAST-001, REQ-SEC2-SAST-002

```
┌─────────┐ ┌─────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌──────────────┐ ┌─────────────────┐
│Developer│ │   CLI   │ │SecurityService  │ │PipelineManager  │ │   Analyzers  │ │NeuroSymbolicCore│
└────┬────┘ └────┬────┘ └───────┬─────────┘ └───────┬─────────┘ └──────┬───────┘ └───────┬─────────┘
     │           │              │                   │                  │                 │
     │ scan ./src│              │                   │                  │                 │
     │──────────>│              │                   │                  │                 │
     │           │              │                   │                  │                 │
     │           │ scan(options)│                   │                  │                 │
     │           │─────────────>│                   │                  │                 │
     │           │              │                   │                  │                 │
     │           │              │ createPipeline()  │                  │                 │
     │           │              │──────────────────>│                  │                 │
     │           │              │                   │                  │                 │
     │           │              │   pipeline        │                  │                 │
     │           │              │<──────────────────│                  │                 │
     │           │              │                   │                  │                 │
     │           │              │ executeParallel() │                  │                 │
     │           │              │──────────────────>│                  │                 │
     │           │              │                   │                  │                 │
     │           │              │                   │ ┌────────────────┴────────────────┐
     │           │              │                   │ │      Parallel Execution         │
     │           │              │                   │ ├─────────────────────────────────┤
     │           │              │                   │ │                                 │
     │           │              │                   │ │  ┌─────────────────────────┐   │
     │           │              │                   │ │  │ SAST: scanDirectory()   │   │
     │           │              │                   │──>│                          │   │
     │           │              │                   │<──│ vulnerabilities[]        │   │
     │           │              │                   │ │  └─────────────────────────┘   │
     │           │              │                   │ │                                 │
     │           │              │                   │ │  ┌─────────────────────────┐   │
     │           │              │                   │ │  │ Taint: analyze()        │   │
     │           │              │                   │──>│                          │   │
     │           │              │                   │<──│ taintPaths[]             │   │
     │           │              │                   │ │  └─────────────────────────┘   │
     │           │              │                   │ │                                 │
     │           │              │                   │ │  ┌─────────────────────────┐   │
     │           │              │                   │ │  │ Secret: detect()        │   │
     │           │              │                   │──>│                          │   │
     │           │              │                   │<──│ secrets[]                │   │
     │           │              │                   │ │  └─────────────────────────┘   │
     │           │              │                   │ │                                 │
     │           │              │                   │ │  ┌─────────────────────────┐   │
     │           │              │                   │ │  │ Dependency: audit()     │   │
     │           │              │                   │──>│                          │   │
     │           │              │                   │<──│ cves[]                   │   │
     │           │              │                   │ │  └─────────────────────────┘   │
     │           │              │                   │ │                                 │
     │           │              │                   │ └─────────────────────────────────┘
     │           │              │                   │                  │                 │
     │           │              │   results[]       │                  │                 │
     │           │              │<──────────────────│                  │                 │
     │           │              │                   │                  │                 │
     │           │              │                   │                  │                 │
     │           │              │ ┌────────────────────────────────────┴─────────────────┐
     │           │              │ │      Neuro-Symbolic Enhancement                      │
     │           │              │ ├──────────────────────────────────────────────────────┤
     │           │              │ │                                                      │
     │           │              │ │  loop [for each vulnerability]                       │
     │           │              │ │  ┌─────────────────────────────────────────────┐    │
     │           │              │ │  │                                             │    │
     │           │              │ │  │   analyze(vuln)                             │    │
     │           │              │───────────────────────────────────────────────────────>│
     │           │              │ │  │                                             │    │
     │           │              │ │  │   ┌─────────────────────────────────────┐  │    │
     │           │              │ │  │   │ 1. symbolicVerify(vuln)             │  │    │
     │           │              │ │  │   │    - queryPattern() → YATA          │  │    │
     │           │              │ │  │   │    - matchRule() → YATA             │  │    │
     │           │              │ │  │   │    → symbolicValid, evidence[]      │  │    │
     │           │              │ │  │   └─────────────────────────────────────┘  │    │
     │           │              │ │  │                                             │    │
     │           │              │ │  │   ┌─────────────────────────────────────┐  │    │
     │           │              │ │  │   │ 2. neuralAnalyze(vuln)              │  │    │
     │           │              │ │  │   │    - LLM API call                   │  │    │
     │           │              │ │  │   │    → confidence, explanation        │  │    │
     │           │              │ │  │   └─────────────────────────────────────┘  │    │
     │           │              │ │  │                                             │    │
     │           │              │ │  │   ┌─────────────────────────────────────┐  │    │
     │           │              │ │  │   │ 3. integrateConfidence()            │  │    │
     │           │              │ │  │   │    REQ-INT-002 Decision Rules:      │  │    │
     │           │              │ │  │   │    - symbolic invalid → reject      │  │    │
     │           │              │ │  │   │    - neural ≥ 0.8 → confirm         │  │    │
     │           │              │ │  │   │    - neural < 0.8 → needs-review    │  │    │
     │           │              │ │  │   └─────────────────────────────────────┘  │    │
     │           │              │ │  │                                             │    │
     │           │              │<─────────────────────────────────────────────────────│
     │           │              │ │  │   NeuroSymbolicResult                    │    │
     │           │              │ │  └─────────────────────────────────────────────┘    │
     │           │              │ │                                                      │
     │           │              │ └──────────────────────────────────────────────────────┘
     │           │              │                   │                  │                 │
     │           │  ScanResult  │                   │                  │                 │
     │           │<─────────────│                   │                  │                 │
     │           │              │                   │                  │                 │
     │ formatted │              │                   │                  │                 │
     │  output   │              │                   │                  │                 │
     │<──────────│              │                   │                  │                 │
     │           │              │                   │                  │                 │
```

---

### 1.2 自動修正生成（Fix Generation）

**ユースケース**: 検出された脆弱性に対してLLMを使った自動修正を生成し、Z3で形式検証

**トレーサビリティ**: REQ-SEC2-FIX-001, REQ-SEC2-FIX-002, REQ-SEC2-FIX-003

```
┌─────────┐ ┌─────────┐ ┌─────────────────┐ ┌──────────────┐ ┌────────────┐ ┌──────────────┐
│Developer│ │   CLI   │ │SecurityService  │ │ FixGenerator │ │ Z3Verifier │ │TestGenerator │
└────┬────┘ └────┬────┘ └───────┬─────────┘ └──────┬───────┘ └─────┬──────┘ └──────┬───────┘
     │           │              │                  │               │               │
     │fix VULN-001              │                  │               │               │
     │──────────>│              │                  │               │               │
     │           │              │                  │               │               │
     │           │generateFix(vulnId)              │               │               │
     │           │─────────────>│                  │               │               │
     │           │              │                  │               │               │
     │           │              │ loadVulnerability│               │               │
     │           │              │ from storage     │               │               │
     │           │              │──────────────────│               │               │
     │           │              │                  │               │               │
     │           │              │ generate(vuln)   │               │               │
     │           │              │─────────────────>│               │               │
     │           │              │                  │               │               │
     │           │              │                  │ ┌────────────────────────────┐
     │           │              │                  │ │   LLM Fix Generation       │
     │           │              │                  │ ├────────────────────────────┤
     │           │              │                  │ │                            │
     │           │              │                  │ │ 1. Build context prompt    │
     │           │              │                  │ │    - Vulnerability info    │
     │           │              │                  │ │    - Surrounding code      │
     │           │              │                  │ │    - Project conventions   │
     │           │              │                  │ │                            │
     │           │              │                  │ │ 2. Call LLM API            │
     │           │              │                  │ │    temperature = 0.3-0.7   │
     │           │              │                  │ │    → Multiple fix candidates│
     │           │              │                  │ │                            │
     │           │              │                  │ │ 3. Parse and rank fixes    │
     │           │              │                  │ │                            │
     │           │              │                  │ └────────────────────────────┘
     │           │              │                  │               │               │
     │           │              │                  │ ┌────────────────────────────────────────┐
     │           │              │                  │ │   Formal Verification Loop              │
     │           │              │                  │ ├────────────────────────────────────────┤
     │           │              │                  │ │                                        │
     │           │              │                  │ │ loop [for each fix candidate]          │
     │           │              │                  │ │ ┌──────────────────────────────────┐  │
     │           │              │                  │ │ │                                  │  │
     │           │              │                  │ │ │  verify(original, fixed, prop)   │  │
     │           │              │                  │────────────────>│               │  │
     │           │              │                  │ │ │                                  │  │
     │           │              │                  │ │ │  ┌──────────────────────────┐   │  │
     │           │              │                  │ │ │  │ Z3 SMT Verification:     │   │  │
     │           │              │                  │ │ │  │ 1. Extract precondition  │   │  │
     │           │              │                  │ │ │  │ 2. Define postcondition  │   │  │
     │           │              │                  │ │ │  │ 3. Generate SMT formula  │   │  │
     │           │              │                  │ │ │  │ 4. Check satisfiability  │   │  │
     │           │              │                  │ │ │  └──────────────────────────┘   │  │
     │           │              │                  │ │ │                                  │  │
     │           │              │                  │<────────────────│               │  │
     │           │              │                  │ │ │  VerificationResult             │  │
     │           │              │                  │ │ │  - verified: boolean            │  │
     │           │              │                  │ │ │  - counterExample / proof       │  │
     │           │              │                  │ │ │                                  │  │
     │           │              │                  │ │ └──────────────────────────────────┘  │
     │           │              │                  │ │                                        │
     │           │              │                  │ └────────────────────────────────────────┘
     │           │              │                  │               │               │
     │           │              │                  │ ┌────────────────────────────────────────────────┐
     │           │              │                  │ │   Test Generation                              │
     │           │              │                  │ ├────────────────────────────────────────────────┤
     │           │              │                  │ │                                                │
     │           │              │                  │ │ loop [for verified fixes]                      │
     │           │              │                  │ │ ┌────────────────────────────────────────┐    │
     │           │              │                  │ │ │                                        │    │
     │           │              │                  │ │ │  generate(vuln, fix)                   │    │
     │           │              │                  │───────────────────────────────────>│    │
     │           │              │                  │ │ │                                        │    │
     │           │              │                  │ │ │  - Regression test (attack blocked)    │    │
     │           │              │                  │ │ │  - Positive test (normal behavior)     │    │
     │           │              │                  │ │ │  - Edge case tests                     │    │
     │           │              │                  │ │ │                                        │    │
     │           │              │                  │<──────────────────────────────────│    │
     │           │              │                  │ │ │  TestCase[]                            │    │
     │           │              │                  │ │ └────────────────────────────────────────┘    │
     │           │              │                  │ │                                                │
     │           │              │                  │ └────────────────────────────────────────────────┘
     │           │              │                  │               │               │
     │           │              │   Fix[]          │               │               │
     │           │              │<─────────────────│               │               │
     │           │              │                  │               │               │
     │           │   Fix[]      │                  │               │               │
     │           │<─────────────│                  │               │               │
     │           │              │                  │               │               │
     │ Display fixes with       │                  │               │               │
     │ - Original code          │                  │               │               │
     │ - Fixed code             │                  │               │               │
     │ - Diff                   │                  │               │               │
     │ - Explanation            │                  │               │               │
     │ - Verification status    │                  │               │               │
     │ - Test cases             │                  │               │               │
     │<──────────│              │                  │               │               │
     │           │              │                  │               │               │
```

---

### 1.3 MCP統合（AIエージェント連携）

**ユースケース**: AIコーディングエージェントがMCPプロトコルでセキュリティ分析を呼び出す

**トレーサビリティ**: REQ-SEC2-INT-003

```
┌──────────┐ ┌───────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌──────────────┐
│ AI Agent │ │MCP Server │ │  Tool Handler   │ │SecurityService  │ │   Storage    │
│(Copilot) │ │           │ │                 │ │                 │ │              │
└────┬─────┘ └─────┬─────┘ └───────┬─────────┘ └───────┬─────────┘ └──────┬───────┘
     │             │               │                   │                  │
     │ tools/call  │               │                   │                  │
     │ security_scan               │                   │                  │
     │ {path: "./src"}             │                   │                  │
     │────────────>│               │                   │                  │
     │             │               │                   │                  │
     │             │ handleTool()  │                   │                  │
     │             │──────────────>│                   │                  │
     │             │               │                   │                  │
     │             │               │ validateInput()   │                  │
     │             │               │──────────────────>│                  │
     │             │               │                   │                  │
     │             │               │ scan(options)     │                  │
     │             │               │──────────────────>│                  │
     │             │               │                   │                  │
     │             │               │                   │  [Full scan      │
     │             │               │                   │   sequence as    │
     │             │               │                   │   shown in 1.1]  │
     │             │               │                   │                  │
     │             │               │   ScanResult      │                  │
     │             │               │<──────────────────│                  │
     │             │               │                   │                  │
     │             │               │ storeResult()     │                  │
     │             │               │─────────────────────────────────────>│
     │             │               │                   │                  │
     │             │               │ formatForMCP()    │                  │
     │             │               │──────────────────>│                  │
     │             │               │                   │                  │
     │             │  result       │                   │                  │
     │             │<──────────────│                   │                  │
     │             │               │                   │                  │
     │   content:  │               │                   │                  │
     │   [{type: "text",           │                   │                  │
     │     text: "Found 5 vulns..."}]                  │                  │
     │<────────────│               │                   │                  │
     │             │               │                   │                  │
     │             │               │                   │                  │
     │ prompts/get │               │                   │                  │
     │ vulnerability_explain       │                   │                  │
     │ {vulnId: "VULN-001"}        │                   │                  │
     │────────────>│               │                   │                  │
     │             │               │                   │                  │
     │             │ handlePrompt()│                   │                  │
     │             │──────────────>│                   │                  │
     │             │               │                   │                  │
     │             │               │ loadVuln(id)      │                  │
     │             │               │─────────────────────────────────────>│
     │             │               │                   │                  │
     │             │               │ generateExplanation()                │
     │             │               │──────────────────>│                  │
     │             │               │                   │                  │
     │             │               │   explanation     │                  │
     │             │               │<──────────────────│                  │
     │             │               │                   │                  │
     │             │  messages[]   │                   │                  │
     │             │<──────────────│                   │                  │
     │             │               │                   │                  │
     │   messages: │               │                   │                  │
     │   [{role: "user",           │                   │                  │
     │     content: "Explain..."}] │                   │                  │
     │<────────────│               │                   │                  │
     │             │               │                   │                  │
```

---

### 1.4 LSP統合（VS Code リアルタイム診断）

**ユースケース**: VS CodeでファイルEditを行うとリアルタイムで脆弱性診断が実行される

**トレーサビリティ**: REQ-SEC2-INT-001

```
┌─────────┐ ┌─────────────┐ ┌───────────────┐ ┌─────────────────┐ ┌────────────────────┐
│ VS Code │ │ LSP Server  │ │DiagnosticsProvi│ │SecurityService  │ │VulnerabilityScanner│
│ Client  │ │             │ │der            │ │                 │ │                    │
└────┬────┘ └──────┬──────┘ └──────┬────────┘ └───────┬─────────┘ └─────────┬──────────┘
     │             │               │                  │                     │
     │ didOpen     │               │                  │                     │
     │ (file.ts)   │               │                  │                     │
     │────────────>│               │                  │                     │
     │             │               │                  │                     │
     │             │ onDidOpen()   │                  │                     │
     │             │──────────────>│                  │                     │
     │             │               │                  │                     │
     │             │               │ scanFile()       │                     │
     │             │               │─────────────────>│                     │
     │             │               │                  │                     │
     │             │               │                  │ scanFile(file.ts)   │
     │             │               │                  │────────────────────>│
     │             │               │                  │                     │
     │             │               │                  │   vulnerabilities[] │
     │             │               │                  │<────────────────────│
     │             │               │                  │                     │
     │             │               │   ScanResult     │                     │
     │             │               │<─────────────────│                     │
     │             │               │                  │                     │
     │             │ Diagnostic[]  │                  │                     │
     │             │<──────────────│                  │                     │
     │             │               │                  │                     │
     │ publishDiag │               │                  │                     │
     │ nostics     │               │                  │                     │
     │<────────────│               │                  │                     │
     │             │               │                  │                     │
     │  [Squiggly lines appear     │                  │                     │
     │   under vulnerable code]    │                  │                     │
     │             │               │                  │                     │
     │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
     │             │               │                  │                     │
     │ didChange   │               │                  │                     │
     │ (file.ts)   │               │                  │                     │
     │────────────>│               │                  │                     │
     │             │               │                  │                     │
     │             │ onDidChange() │                  │                     │
     │             │──────────────>│                  │                     │
     │             │               │                  │                     │
     │             │               │ debounce(300ms)  │                     │
     │             │               │─────────────────>│                     │
     │             │               │                  │                     │
     │             │               │ [Incremental scan for changed range]  │
     │             │               │                  │                     │
     │             │               │   ScanResult     │                     │
     │             │               │<─────────────────│                     │
     │             │               │                  │                     │
     │             │ Diagnostic[]  │                  │                     │
     │             │<──────────────│                  │                     │
     │             │               │                  │                     │
     │ publishDiag │               │                  │                     │
     │ nostics     │               │                  │                     │
     │<────────────│               │                  │                     │
     │             │               │                  │                     │
     │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
     │             │               │                  │                     │
     │ codeAction  │               │                  │                     │
     │ request     │               │                  │                     │
     │────────────>│               │                  │                     │
     │             │               │                  │                     │
     │             │ onCodeAction()│                  │                     │
     │             │──────────────>│                  │                     │
     │             │               │                  │                     │
     │             │               │ generateFix()    │                     │
     │             │               │─────────────────>│                     │
     │             │               │                  │                     │
     │             │               │   Fix[]          │                     │
     │             │               │<─────────────────│                     │
     │             │               │                  │                     │
     │             │ CodeAction[]  │                  │                     │
     │             │<──────────────│                  │                     │
     │             │               │                  │                     │
     │ Quick Fix   │               │                  │                     │
     │ options     │               │                  │                     │
     │<────────────│               │                  │                     │
     │             │               │                  │                     │
```

---

### 1.5 依存関係監査（SBOM生成含む）

**ユースケース**: package.jsonを監査し、脆弱な依存関係を検出、SBOMを生成

**トレーサビリティ**: REQ-SEC2-DEP-001, REQ-SEC2-DEP-002, REQ-SEC2-DEP-003

```
┌─────────┐ ┌─────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌────────────┐ ┌────────────┐
│Developer│ │   CLI   │ │DependencyAuditor│ │SupplyChainAnaly │ │ CVE Client │ │SBOMGenerator
└────┬────┘ └────┬────┘ └───────┬─────────┘ └───────┬─────────┘ └─────┬──────┘ └─────┬──────┘
     │           │              │                   │                 │              │
     │audit ./   │              │                   │                 │              │
     │ --sbom    │              │                   │                 │              │
     │──────────>│              │                   │                 │              │
     │           │              │                   │                 │              │
     │           │ audit(path, options)             │                 │              │
     │           │─────────────>│                   │                 │              │
     │           │              │                   │                 │              │
     │           │              │ parseLockfile()   │                 │              │
     │           │              │ → dependencies[]  │                 │              │
     │           │              │                   │                 │              │
     │           │              │ ┌──────────────────────────────────────────────────┐
     │           │              │ │   CVE Check Loop                                 │
     │           │              │ ├──────────────────────────────────────────────────┤
     │           │              │ │                                                  │
     │           │              │ │ loop [for each dependency]                       │
     │           │              │ │ ┌──────────────────────────────────────────┐    │
     │           │              │ │ │                                          │    │
     │           │              │ │ │ checkCVE(dep)                            │    │
     │           │              │──────────────────────────────>│              │    │
     │           │              │ │ │                                          │    │
     │           │              │ │ │  Query multiple sources:                 │    │
     │           │              │ │ │  - NVD API                               │    │
     │           │              │ │ │  - OSV API                               │    │
     │           │              │ │ │  - GitHub Advisory GraphQL               │    │
     │           │              │ │ │  - Snyk API                              │    │
     │           │              │ │ │                                          │    │
     │           │              │<─────────────────────────────│              │    │
     │           │              │ │ │  CVE[]                                   │    │
     │           │              │ │ │                                          │    │
     │           │              │ │ └──────────────────────────────────────────┘    │
     │           │              │ │                                                  │
     │           │              │ └──────────────────────────────────────────────────┘
     │           │              │                   │                 │              │
     │           │              │ ┌──────────────────────────────────────────────────┐
     │           │              │ │   Supply Chain Analysis                          │
     │           │              │ ├──────────────────────────────────────────────────┤
     │           │              │ │                                                  │
     │           │              │ │ analyzeSupplyChain(dep)                          │
     │           │              │─────────────────>│                 │              │
     │           │              │ │                                                  │
     │           │              │ │  Checks:                                         │
     │           │              │ │  - Typosquatting (Levenshtein distance)          │
     │           │              │ │  - Dependency confusion (private registry)       │
     │           │              │ │  - Maintainer changes (npm registry)             │
     │           │              │ │  - Malicious code patterns                       │
     │           │              │ │                                                  │
     │           │              │<────────────────│                 │              │
     │           │              │ │  SupplyChainRisk                                 │
     │           │              │ │                                                  │
     │           │              │ └──────────────────────────────────────────────────┘
     │           │              │                   │                 │              │
     │           │              │ ┌──────────────────────────────────────────────────────────┐
     │           │              │ │   SBOM Generation                                        │
     │           │              │ ├──────────────────────────────────────────────────────────┤
     │           │              │ │                                                          │
     │           │              │ │ generateSBOM(format)                                     │
     │           │              │───────────────────────────────────────────────>│
     │           │              │ │                                                          │
     │           │              │ │  - Convert dependencies to SPDX/CycloneDX               │
     │           │              │ │  - Add license info                                      │
     │           │              │ │  - Calculate hashes                                      │
     │           │              │ │  - Generate PURLs                                        │
     │           │              │ │                                                          │
     │           │              │<──────────────────────────────────────────────│
     │           │              │ │  SBOM                                                    │
     │           │              │ │                                                          │
     │           │              │ └──────────────────────────────────────────────────────────┘
     │           │              │                   │                 │              │
     │           │ AuditResult  │                   │                 │              │
     │           │ + SBOM       │                   │                 │              │
     │           │<─────────────│                   │                 │              │
     │           │              │                   │                 │              │
     │ Formatted │              │                   │                 │              │
     │ report    │              │                   │                 │              │
     │<──────────│              │                   │                 │              │
     │           │              │                   │                 │              │
```

---

## 2. データフロー図

### 2.1 スキャンデータフロー

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                           Security Scan Data Flow                              │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐                                                                │
│  │Source    │                                                                │
│  │Files     │                                                                │
│  └────┬─────┘                                                                │
│       │                                                                       │
│       ▼                                                                       │
│  ┌──────────┐     ┌──────────────────────────────────────────────────────┐  │
│  │AST Parser├────>│                   Analysis Pipeline                   │  │
│  └──────────┘     │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │  │
│                   │  │ SAST    │ │ Taint   │ │ Secret  │ │ Depend  │    │  │
│                   │  │ Analyze │ │ Analyze │ │ Detect  │ │ Audit   │    │  │
│                   │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘    │  │
│                   └───────┼──────────┼──────────┼──────────┼────────────┘  │
│                           │          │          │          │               │
│                           └──────────┼──────────┼──────────┘               │
│                                      │          │                          │
│                                      ▼          ▼                          │
│                              ┌───────────────────────┐                     │
│                              │  Result Aggregator    │                     │
│                              │  - Deduplicate        │                     │
│                              │  - Prioritize         │                     │
│                              └──────────┬────────────┘                     │
│                                         │                                  │
│                                         ▼                                  │
│                              ┌───────────────────────┐                     │
│                              │ Neuro-Symbolic Core   │                     │
│                              │                       │                     │
│  ┌──────────┐               │  ┌───────────────┐   │   ┌──────────┐      │
│  │   YATA   │<──────────────│──│ Symbolic      │   │   │   LLM    │      │
│  │Knowledge │               │  │ Verification  │   │   │   API    │      │
│  │  Graph   │───────────────│─>│               │   │<──│          │      │
│  └──────────┘               │  └───────────────┘   │   └──────────┘      │
│                             │          │           │                      │
│                             │          ▼           │                      │
│                             │  ┌───────────────┐   │                      │
│                             │  │ Confidence    │   │                      │
│                             │  │ Integration   │   │                      │
│                             │  │ (REQ-INT-002) │   │                      │
│                             │  └───────────────┘   │                      │
│                             └──────────┬───────────┘                      │
│                                        │                                  │
│                                        ▼                                  │
│                             ┌───────────────────────┐                     │
│                             │  Enhanced Vulnerab.   │                     │
│                             │  - confirmed/rejected │                     │
│                             │  - explanations       │                     │
│                             │  - evidence           │                     │
│                             └──────────┬────────────┘                     │
│                                        │                                  │
│               ┌────────────────────────┼────────────────────────┐        │
│               │                        │                        │        │
│               ▼                        ▼                        ▼        │
│        ┌──────────┐             ┌──────────┐             ┌──────────┐   │
│        │   CLI    │             │   MCP    │             │   LSP    │   │
│        │  Output  │             │ Response │             │Diagnostics│   │
│        └──────────┘             └──────────┘             └──────────┘   │
│                                                                          │
└───────────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 修正生成データフロー

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                          Fix Generation Data Flow                              │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────┐                                                            │
│  │Vulnerability │                                                            │
│  └──────┬───────┘                                                            │
│         │                                                                     │
│         ▼                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        Fix Generator                                  │   │
│  │                                                                       │   │
│  │   ┌─────────────────┐                                                │   │
│  │   │ Context Builder │                                                │   │
│  │   │ - vuln info     │                                                │   │
│  │   │ - code context  │                                                │   │
│  │   │ - conventions   │                                                │   │
│  │   └────────┬────────┘                                                │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────┐     ┌──────────┐                              │   │
│  │   │  LLM Prompting  │────>│  LLM API │                              │   │
│  │   │  (multi-temp)   │<────│          │                              │   │
│  │   └────────┬────────┘     └──────────┘                              │   │
│  │            │                                                          │   │
│  │            ▼ Fix candidates[]                                         │   │
│  │   ┌─────────────────┐                                                │   │
│  │   │  Fix Ranker     │                                                │   │
│  │   │  - similarity   │                                                │   │
│  │   │  - complexity   │                                                │   │
│  │   │  - convention   │                                                │   │
│  │   └────────┬────────┘                                                │   │
│  │            │                                                          │   │
│  └────────────┼─────────────────────────────────────────────────────────┘   │
│               │                                                              │
│               ▼                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                       Z3 Verifier                                     │   │
│  │                                                                       │   │
│  │   ┌─────────────────┐                                                │   │
│  │   │Precondition     │  "Attack can reach vulnerable sink"            │   │
│  │   │Extraction       │                                                │   │
│  │   └────────┬────────┘                                                │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────┐                                                │   │
│  │   │Postcondition    │  "Attack is blocked/sanitized"                 │   │
│  │   │Definition       │                                                │   │
│  │   └────────┬────────┘                                                │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────┐     ┌──────────┐                              │   │
│  │   │ SMT Formula     │────>│    Z3    │                              │   │
│  │   │ Generation      │<────│  Solver  │                              │   │
│  │   └────────┬────────┘     └──────────┘                              │   │
│  │            │                                                          │   │
│  │            ▼ verified: true/false                                     │   │
│  │   ┌─────────────────┐                                                │   │
│  │   │ Counter-example │  (if verification fails)                       │   │
│  │   │ or Proof        │  (if verification succeeds)                    │   │
│  │   └────────┬────────┘                                                │   │
│  │            │                                                          │   │
│  └────────────┼─────────────────────────────────────────────────────────┘   │
│               │                                                              │
│               ▼ Verified fixes only                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                      Test Generator                                   │   │
│  │                                                                       │   │
│  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│  │   │ Regression    │  │   Positive    │  │  Edge Case    │           │   │
│  │   │ Test          │  │   Test        │  │  Tests        │           │   │
│  │   │ (attack       │  │ (normal       │  │ (boundary     │           │   │
│  │   │  blocked)     │  │  behavior)    │  │  conditions)  │           │   │
│  │   └───────┬───────┘  └───────┬───────┘  └───────┬───────┘           │   │
│  │           │                  │                  │                    │   │
│  │           └──────────────────┼──────────────────┘                    │   │
│  │                              │                                       │   │
│  └──────────────────────────────┼───────────────────────────────────────┘   │
│                                 │                                           │
│                                 ▼                                           │
│                       ┌──────────────────┐                                 │
│                       │  Complete Fix    │                                 │
│                       │  - fixedCode     │                                 │
│                       │  - diff          │                                 │
│                       │  - explanation   │                                 │
│                       │  - verified: true│                                 │
│                       │  - testCases[]   │                                 │
│                       └──────────────────┘                                 │
│                                                                             │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 状態遷移図

### 3.1 脆弱性ライフサイクル

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                      Vulnerability State Machine                               │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│                                                                               │
│                    ┌─────────────────────────────────────┐                   │
│                    │                                     │                   │
│                    │          ┌──────────┐               │                   │
│    ┌───────┐       │          │          │               │                   │
│    │       │  scan │          │ detected │               │                   │
│    │ none  │───────┼─────────>│          │               │                   │
│    │       │       │          │          │               │                   │
│    └───────┘       │          └────┬─────┘               │                   │
│                    │               │                     │                   │
│                    │               │ neuro-symbolic      │                   │
│                    │               │ analysis            │                   │
│                    │               │                     │                   │
│                    │    ┌──────────┼──────────┐         │                   │
│                    │    │          │          │         │                   │
│                    │    ▼          ▼          ▼         │                   │
│                    │ ┌──────┐ ┌──────────┐ ┌──────┐    │                   │
│                    │ │      │ │  needs   │ │      │    │                   │
│                    │ │reject│ │  review  │ │confirm│   │                   │
│                    │ │ed    │ │          │ │ed    │    │                   │
│                    │ └──┬───┘ └────┬─────┘ └──┬───┘    │                   │
│                    │    │          │          │         │                   │
│                    │    │          │ manual   │         │                   │
│                    │    │          │ review   │         │                   │
│                    │    │          │          │         │                   │
│                    │    │     ┌────┴────┐    │         │                   │
│                    │    │     │         │    │         │                   │
│                    │    │     ▼         ▼    │         │                   │
│                    │    │  ┌─────┐  ┌─────┐  │         │                   │
│                    │    │  │false│  │true │  │         │                   │
│                    │    │  │pos  │  │pos  │  │         │                   │
│                    │    │  └──┬──┘  └──┬──┘  │         │                   │
│                    │    │     │        │     │         │                   │
│                    │    │     │        └─────┼─────────┤                   │
│                    │    │     │              │         │                   │
│                    │    └─────┼──────────────┘         │                   │
│                    │          │                        │                   │
│                    │          ▼                        │                   │
│                    │    ┌───────────┐                  │                   │
│                    │    │           │                  │                   │
│                    │    │ dismissed │                  │                   │
│                    │    │           │                  │                   │
│                    │    └───────────┘                  │                   │
│                    │                                   │                   │
│                    │          confirmed                │                   │
│                    │          vulnerabilities          │                   │
│                    │               │                   │                   │
│                    │               │                   │                   │
│                    │               ▼                   │                   │
│                    │        ┌─────────────┐           │                   │
│                    │        │  fix        │           │                   │
│                    │        │  suggested  │           │                   │
│                    │        └──────┬──────┘           │                   │
│                    │               │                   │                   │
│                    │               │ fix verified      │                   │
│                    │               │                   │                   │
│                    │               ▼                   │                   │
│                    │        ┌─────────────┐           │                   │
│                    │        │  fix        │           │                   │
│                    │        │  verified   │           │                   │
│                    │        └──────┬──────┘           │                   │
│                    │               │                   │                   │
│                    │               │ fix applied       │                   │
│                    │               │                   │                   │
│                    │               ▼                   │                   │
│                    │        ┌─────────────┐           │                   │
│                    │        │             │           │                   │
│                    │        │  resolved   │           │                   │
│                    │        │             │           │                   │
│                    │        └─────────────┘           │                   │
│                    │                                   │                   │
│                    └───────────────────────────────────┘                   │
│                                                                             │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 0.1.0 | 2026-01-07 | 初版作成（全シーケンス図） | AI Agent |

