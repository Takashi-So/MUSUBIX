# Budget Tracker System - 設計書 v2.0

**Project ID**: project-13-budget-tracker
**Document ID**: DES-001
**Version**: 2.0 (Revised after Review)
**Created**: 2026-01-04
**Status**: ✅ Approved

---

## 1. C4 Model - Context Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         Context Level                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│    ┌──────────┐         ┌─────────────────────┐                 │
│    │   User   │────────▶│  Budget Tracker     │                 │
│    │ (Person) │◀────────│     System          │                 │
│    └──────────┘         └─────────────────────┘                 │
│         │                        │                               │
│         │ Uses web/CLI           │                               │
│         │ interface              │                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. C4 Model - Container Diagram

| Container | Technology | Purpose |
|-----------|------------|---------|
| CLI Application | Node.js / TypeScript | ユーザーインターフェース |
| Core Library | TypeScript | ビジネスロジック（Library-First） |
| JSON File Storage | File System | データ永続化（v1.0） |

---

## 3. 技術スタック

| Category | Technology | Rationale |
|----------|------------|-----------|
| Language | TypeScript 5.x | 型安全性、MUSUBIX標準 |
| Runtime | Node.js 20+ | LTS、ESM対応 |
| Testing | Vitest | 高速、ESM対応 |
| Storage | JSON Files | シンプル、v1.0向け |

---

## 4. Domain Model

### 4.1 Entity Definitions

#### User Entity
```typescript
interface User {
  id: UserId;           // USR-XXXXXXXX
  email: Email;
  passwordHash: string;
  createdAt: Date;
  status: UserStatus;
}

type UserStatus = 'active' | 'archived';
```
**Traces to**: REQ-BT-040, REQ-BT-041

#### Category Entity
```typescript
interface Category {
  id: CategoryId;       // CAT-YYYYMMDD-NNN
  userId: UserId;
  name: string;
  description: string;
  monthlyLimit: Money;
  status: CategoryStatus;
  createdAt: Date;
  updatedAt: Date;
}

type CategoryStatus = 'active' | 'archived';
```
**Traces to**: REQ-BT-001, REQ-BT-002, REQ-BT-003, REQ-BT-004

#### Expense Entity
```typescript
interface Expense {
  id: ExpenseId;        // EXP-YYYYMMDD-NNN
  userId: UserId;
  categoryId: CategoryId;
  amount: Money;
  date: Date;
  description: string;
  status: ExpenseStatus;
  createdAt: Date;
  updatedAt: Date;
}

type ExpenseStatus = 'active' | 'archived';
```
**Traces to**: REQ-BT-010, REQ-BT-011, REQ-BT-012, REQ-BT-013

#### Alert Entity
```typescript
interface Alert {
  id: AlertId;          // ALT-YYYYMMDD-NNN
  userId: UserId;
  categoryId: CategoryId;
  type: AlertType;
  budgetPeriod: BudgetPeriod;
  status: AlertStatus;
  createdAt: Date;
  readAt?: Date;
}

type AlertType = 'warning' | 'exceeded';
type AlertStatus = 'unread' | 'read';
```
**Traces to**: REQ-BT-030, REQ-BT-031, REQ-BT-032, REQ-BT-033

### 4.2 Status Transition Maps (BP-DESIGN-001)

```typescript
// Category Status Transitions
const categoryStatusTransitions: Record<CategoryStatus, CategoryStatus[]> = {
  active: ['archived'],
  archived: []  // 復元不可（v1.0）
};

// Expense Status Transitions  
const expenseStatusTransitions: Record<ExpenseStatus, ExpenseStatus[]> = {
  active: ['archived'],
  archived: []  // 復元不可（v1.0）
};

// Alert Status Transitions
const alertStatusTransitions: Record<AlertStatus, AlertStatus[]> = {
  unread: ['read'],
  read: []  // 既読から未読への変更不可
};
```

### 4.3 Value Objects

#### Money Value Object
```typescript
class Money {
  private constructor(private readonly amount: number) {}
  
  static create(amount: number): Result<Money, ValidationError> {
    if (amount < 1 || amount > 999_999_999) {
      return err(new ValidationError('Amount must be between 1 and 999,999,999'));
    }
    if (!Number.isInteger(amount)) {
      return err(new ValidationError('Amount must be an integer'));
    }
    return ok(new Money(amount));
  }
  
  static zero(): Money { return new Money(0); }
  add(other: Money): Money { return new Money(this.amount + other.amount); }
  subtract(other: Money): Money { return new Money(Math.max(0, this.amount - other.amount)); }
  percentage(total: Money): number { 
    if (total.amount === 0) return 0;
    return Math.round((this.amount / total.amount) * 100);
  }
  toNumber(): number { return this.amount; }
  equals(other: Money): boolean { return this.amount === other.amount; }
}
```

#### BudgetPeriod Value Object
```typescript
class BudgetPeriod {
  private constructor(
    private readonly year: number,
    private readonly month: number  // 1-12
  ) {}
  
  static current(): BudgetPeriod {
    const now = new Date();
    return new BudgetPeriod(now.getFullYear(), now.getMonth() + 1);
  }
  
  static fromDate(date: Date): BudgetPeriod {
    return new BudgetPeriod(date.getFullYear(), date.getMonth() + 1);
  }
  
  static fromYearMonth(year: number, month: number): Result<BudgetPeriod, ValidationError> {
    if (month < 1 || month > 12) {
      return err(new ValidationError('Month must be between 1 and 12'));
    }
    return ok(new BudgetPeriod(year, month));
  }
  
  getStartDate(): Date { 
    return new Date(this.year, this.month - 1, 1, 0, 0, 0, 0);
  }
  
  getEndDate(): Date {
    return new Date(this.year, this.month, 0, 23, 59, 59, 999);
  }
  
  equals(other: BudgetPeriod): boolean {
    return this.year === other.year && this.month === other.month;
  }
  
  toString(): string {
    return `${this.year}-${String(this.month).padStart(2, '0')}`;
  }
}
```

#### BudgetStatus Value Object
```typescript
type BudgetStatus = 'normal' | 'warning' | 'exceeded';

function calculateBudgetStatus(spending: Money, limit: Money): BudgetStatus {
  const percentage = spending.percentage(limit);
  if (percentage >= 100) return 'exceeded';
  if (percentage >= 80) return 'warning';
  return 'normal';
}
```

---

## 5. Input DTOs (BP-CODE-001 対応)

### 5.1 Auth DTOs
```typescript
interface RegisterUserInput {
  email: string;
  password: string;
}

interface LoginInput {
  email: string;
  password: string;
}
```

### 5.2 Category DTOs
```typescript
interface CreateCategoryInput {
  name: string;
  description: string;
  monthlyLimit: number;  // 円単位の整数
}

interface UpdateCategoryInput {
  name?: string;
  description?: string;
  monthlyLimit?: number;
}
```

### 5.3 Expense DTOs
```typescript
interface RecordExpenseInput {
  categoryId: string;
  amount: number;
  date: string;        // ISO 8601 形式
  description: string;
}

interface UpdateExpenseInput {
  categoryId?: string;
  amount?: number;
  date?: string;
  description?: string;
}

interface ExpenseFilter {
  categoryId?: string;
  startDate?: string;
  endDate?: string;
  status?: ExpenseStatus;
}
```

---

## 6. Service Design

### 6.1 AuthService
```typescript
interface AuthService {
  register(input: RegisterUserInput): Promise<Result<User, AuthError>>;
  login(input: LoginInput): Promise<Result<AccessToken, AuthError>>;
  logout(token: AccessToken): Promise<void>;
  validateToken(token: AccessToken): Promise<Result<UserId, AuthError>>;
}
```

### 6.2 CategoryService
```typescript
interface CategoryService {
  create(userId: UserId, input: CreateCategoryInput): Promise<Result<Category, DomainError>>;
  list(userId: UserId): Promise<CategoryWithSpending[]>;
  update(userId: UserId, categoryId: CategoryId, input: UpdateCategoryInput): Promise<Result<Category, DomainError>>;
  archive(userId: UserId, categoryId: CategoryId): Promise<Result<void, DomainError>>;
}

interface CategoryWithSpending extends Category {
  currentMonthSpending: Money;
  budgetStatus: BudgetStatus;
}
```

### 6.3 ExpenseService
```typescript
interface ExpenseService {
  record(userId: UserId, input: RecordExpenseInput): Promise<Result<Expense, DomainError>>;
  list(userId: UserId, filter: ExpenseFilter): Promise<Expense[]>;
  update(userId: UserId, expenseId: ExpenseId, input: UpdateExpenseInput): Promise<Result<Expense, DomainError>>;
  archive(userId: UserId, expenseId: ExpenseId): Promise<Result<void, DomainError>>;
}
```

### 6.4 AnalysisService
```typescript
interface AnalysisService {
  getMonthlySummary(userId: UserId, period: BudgetPeriod): Promise<MonthlySummary>;
  getCategoryAnalysis(userId: UserId, categoryId: CategoryId, period: BudgetPeriod): Promise<CategoryAnalysis>;
}

interface MonthlySummary {
  period: BudgetPeriod;
  totalBudget: Money;
  totalSpending: Money;
  remainingBudget: Money;
  categoryBreakdown: CategorySummary[];
}

interface CategorySummary {
  category: Category;
  spending: Money;
  percentage: number;
  status: BudgetStatus;
}

interface CategoryAnalysis {
  category: Category;
  period: BudgetPeriod;
  dailySpending: DailySpending[];
  averageDaily: Money;
  previousPeriodTotal?: Money;
  changePercentage?: number;
}

interface DailySpending {
  date: Date;
  amount: Money;
}
```

### 6.5 AlertService
```typescript
interface AlertService {
  checkAndGenerateAlerts(userId: UserId, categoryId: CategoryId): Promise<Alert[]>;
  getUnreadAlerts(userId: UserId): Promise<Alert[]>;
  acknowledge(userId: UserId, alertId: AlertId): Promise<Result<void, DomainError>>;
}
```

---

## 7. Repository Interfaces

```typescript
interface UserRepository {
  save(user: User): Promise<void>;
  findById(id: UserId): Promise<User | null>;
  findByEmail(email: string): Promise<User | null>;
}

interface CategoryRepository {
  save(category: Category): Promise<void>;
  findById(id: CategoryId): Promise<Category | null>;
  findByUserId(userId: UserId): Promise<Category[]>;
  findActiveByUserId(userId: UserId): Promise<Category[]>;
  existsByNameAndUserId(name: string, userId: UserId): Promise<boolean>;
}

interface ExpenseRepository {
  save(expense: Expense): Promise<void>;
  findById(id: ExpenseId): Promise<Expense | null>;
  findByFilter(userId: UserId, filter: ExpenseFilter): Promise<Expense[]>;
  sumByCategory(categoryId: CategoryId, period: BudgetPeriod): Promise<Money>;
}

interface AlertRepository {
  save(alert: Alert): Promise<void>;
  findUnreadByUser(userId: UserId): Promise<Alert[]>;
  existsForCategoryAndType(
    categoryId: CategoryId, 
    type: AlertType, 
    period: BudgetPeriod
  ): Promise<boolean>;
}
```

---

## 8. ID Generation Strategy

### 8.1 Format
| Entity | Format | Example |
|--------|--------|---------|
| User | USR-{8 hex} | USR-A1B2C3D4 |
| Category | CAT-{YYYYMMDD}-{NNN} | CAT-20260104-001 |
| Expense | EXP-{YYYYMMDD}-{NNN} | EXP-20260104-001 |
| Alert | ALT-{YYYYMMDD}-{NNN} | ALT-20260104-001 |

### 8.2 Counter Management (BP-TEST-001 対応)
```typescript
// 各Entity moduleでカウンター管理
let categoryCounter = 0;

export function generateCategoryId(): CategoryId {
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  categoryCounter++;
  return `CAT-${date}-${String(categoryCounter).padStart(3, '0')}` as CategoryId;
}

// テスト用リセット関数
export function resetCategoryCounter(): void {
  categoryCounter = 0;
}
```

---

## 9. Directory Structure

```
project-13-budget-tracker/
├── docs/
│   ├── requirements/
│   ├── design/
│   └── reviews/
├── src/
│   ├── domain/
│   │   ├── entities/
│   │   │   ├── user.ts
│   │   │   ├── category.ts
│   │   │   ├── expense.ts
│   │   │   └── alert.ts
│   │   ├── value-objects/
│   │   │   ├── money.ts
│   │   │   ├── budget-period.ts
│   │   │   └── budget-status.ts
│   │   └── repositories/
│   │       └── interfaces.ts
│   ├── application/
│   │   ├── dto/
│   │   │   ├── auth-dto.ts
│   │   │   ├── category-dto.ts
│   │   │   └── expense-dto.ts
│   │   ├── auth-service.ts
│   │   ├── category-service.ts
│   │   ├── expense-service.ts
│   │   ├── analysis-service.ts
│   │   └── alert-service.ts
│   ├── infrastructure/
│   │   ├── json-storage.ts
│   │   └── repositories/
│   │       ├── json-user-repository.ts
│   │       ├── json-category-repository.ts
│   │       ├── json-expense-repository.ts
│   │       └── json-alert-repository.ts
│   └── cli/
│       ├── index.ts
│       └── commands/
├── tests/
│   ├── domain/
│   ├── application/
│   └── integration/
├── package.json
├── tsconfig.json
└── vitest.config.ts
```

---

## 10. Design Patterns Applied

| Pattern | Application | Rationale |
|---------|-------------|-----------|
| Repository | Data access abstraction | テスタビリティ、DBの差し替え可能 |
| Service Layer | Business logic orchestration | ドメインロジックの集約 |
| Value Object | Money, BudgetPeriod, BudgetStatus | イミュータブル、自己検証 |
| Result Type | Error handling | 例外より明示的なエラー処理 |
| Factory | Entity creation | ID生成、検証の一元化 |
| Input DTO | Service method parameters | 明確なインターフェース契約 |
| Status Transition Map | State management | 有効な状態遷移の定義 |

---

## 11. Traceability Matrix

| 要件ID | 設計コンポーネント | DTO | テストID |
|--------|-------------------|-----|----------|
| REQ-BT-040 | AuthService.register | RegisterUserInput | TST-AUTH-001 |
| REQ-BT-041 | AuthService.login | LoginInput | TST-AUTH-002 |
| REQ-BT-001 | CategoryService.create | CreateCategoryInput | TST-CAT-001 |
| REQ-BT-002 | CategoryService.list | - | TST-CAT-002 |
| REQ-BT-003 | CategoryService.update | UpdateCategoryInput | TST-CAT-003 |
| REQ-BT-004 | CategoryService.archive | - | TST-CAT-004 |
| REQ-BT-010 | ExpenseService.record | RecordExpenseInput | TST-EXP-001 |
| REQ-BT-011 | ExpenseService.list | ExpenseFilter | TST-EXP-002 |
| REQ-BT-020 | AnalysisService.getMonthlySummary | - | TST-ANA-001 |
| REQ-BT-022 | calculateBudgetStatus | - | TST-STA-001 |
| REQ-BT-023 | calculateBudgetStatus | - | TST-STA-002 |
| REQ-BT-030 | AlertService.checkAndGenerateAlerts | - | TST-ALT-001 |

---

## 12. Review Feedback Resolution

| Issue ID | 問題 | 対応 |
|----------|------|------|
| DES-ISSUE-001 | Input DTO未定義 | Section 5でDTO定義追加 |
| DES-ISSUE-002 | AlertService責務過多 | v2.0で対応（現状維持） |
| DES-ISSUE-003 | トークン管理不足 | v2.0で対応（現状維持） |
| DES-ISSUE-004 | 認可チェック不明確 | v2.0で対応（現状維持） |
| DES-ISSUE-005 | ID並行性問題 | Section 8.2でカウンター管理追加 |
| (追加) | Status Transition未定義 | Section 4.2で追加 |

---

**Document History**:
| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-04 | AI Architect | Initial design |
| 2.0 | 2026-01-04 | AI Architect | Review feedback incorporated |

**Approval**:
- [x] Architecture sound
- [x] SOLID principles followed
- [x] Best practices applied
- [x] Ready for Task Decomposition
