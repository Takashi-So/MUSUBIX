# 要件定義書: Pet Clinic Reservation System
# バージョン: 1.1.0 (レビュー後修正版)
# 作成日: 2026-01-04
# 更新日: 2026-01-04
# ドメイン: veterinary

## 1. プロジェクト概要

### 1.1 目的
動物病院の予約管理を効率化し、飼い主と獣医師の双方の利便性を向上させるシステムを構築する。

### 1.2 スコープ
- ペット登録・管理
- 予約の作成・変更・キャンセル
- 獣医師スケジュール管理
- 診療記録管理
- 通知機能

---

## 2. 機能要件（EARS形式）

### 2.1 ペット管理機能

#### REQ-PET-001: ペット登録
**[Ubiquitous]**
THE システム SHALL ペット情報（名前、種類、品種、生年月日、体重、アレルギー情報）を入力フォームから受け取り、バリデーション後にデータベースへ永続化する

#### REQ-PET-002: ペット情報更新
**[Event-driven]**
WHEN 飼い主がペット情報編集画面で保存ボタンをクリックする
THE システム SHALL 更新前データのスナップショットを履歴テーブルに保存し、ペット情報を更新する

#### REQ-PET-003: ペット一覧表示
**[State-driven]**
WHILE ユーザーが認証済みセッションを保持している
THE システム SHALL 当該ユーザーに紐づく全ペット情報を取得し、名前・種類・最終診療日を含むリスト形式で表示する

### 2.2 予約管理機能

#### REQ-RESERVE-001: 予約作成
**[Event-driven]**
WHEN 飼い主が希望日時・獣医師・診療内容を選択して予約フォームを送信する
THE システム SHALL 指定獣医師の該当時間枠の空き状況をリアルタイムで確認し、空きがあれば予約レコードをステータス「confirmed」で作成し、30秒以内に予約確認メールを送信する

#### REQ-RESERVE-002: 予約変更
**[Event-driven]**
WHEN 飼い主が既存予約の日時変更をリクエストする
THE システム SHALL 変更先時間枠の空き状況を確認し、予約日時の24時間前以上であれば変更を許可し、予約ステータスを「rescheduled」に更新する

#### REQ-RESERVE-003: 予約キャンセル
**[Optional]**
IF 予約日時まで24時間未満でキャンセルリクエストが発生した場合
THEN THE システム SHALL キャンセル料（診療予定費用の50%）の発生を画面に表示し、確認後にステータスを「cancelled_with_fee」に更新する

#### REQ-RESERVE-004: 重複予約防止
**[Unwanted]**
THE システム SHALL NOT 同一ペットIDに対して予約日時が重複する（開始時刻から終了時刻の範囲が重なる）予約レコードの作成を許可する（一意制約違反時はエラーコードERR-DUP-001を返却）

### 2.3 獣医師スケジュール管理

#### REQ-VET-001: スケジュール設定
**[Ubiquitous]**
THE システム SHALL 獣医師が曜日別の勤務開始時刻・終了時刻・休憩時間（複数設定可）を15分単位で入力し、週間スケジュールテンプレートとして保存できる機能を提供する

#### REQ-VET-002: 予約枠表示
**[State-driven]**
WHILE 予約画面で獣医師が選択されている
THE システム SHALL 選択された獣医師の当日から2週間先までの空き予約枠を5秒以内に取得し、カレンダー形式で表示する

#### REQ-VET-003: 休診日設定
**[Event-driven]**
WHEN 管理者が特定日を休診日として登録する
THE システム SHALL 該当日の全予約枠をステータス「blocked」に変更し、既存予約がある場合は予約件数とペット名のリストを含む警告モーダルを表示する

### 2.4 診療記録管理

#### REQ-MEDICAL-001: 診療記録作成
**[Event-driven]**
WHEN 獣医師が診療完了ボタンをクリックする
THE システム SHALL 診療内容（症状・診断名・処置）、処方薬（薬品名・用量・日数）、次回予約推奨日を構造化データとして記録し、予約ステータスを「completed」に更新する

#### REQ-MEDICAL-002: 診療履歴参照
**[Ubiquitous]**
THE システム SHALL ペットIDを指定して診療履歴を降順（最新順）で取得し、診療日・診断名・担当獣医師名を含むリスト形式で表示する機能を提供する

#### REQ-MEDICAL-003: ワクチン接種管理
**[Event-driven]**
WHEN ワクチン接種が診療記録に登録される
THE システム SHALL ワクチン種別に応じた接種間隔（狂犬病:1年、混合ワクチン:1年、フィラリア:月次）を基に次回接種予定日を自動計算し、リマインダーレコードを作成する

### 2.5 通知機能

#### REQ-NOTIFY-001: 予約リマインダー
**[Event-driven]**
WHEN 予約日時の24時間前（±5分）のタイミングになる
THE システム SHALL 飼い主のメールアドレスおよびプッシュ通知設定に基づき、予約日時・病院名・ペット名を含むリマインダー通知を送信する

#### REQ-NOTIFY-002: ワクチンリマインダー
**[Event-driven]**
WHEN ワクチン接種予定日の7日前（午前9時）になる
THE システム SHALL 飼い主にワクチン名・ペット名・推奨接種日を含む通知をメールで送信する

#### REQ-NOTIFY-003: 緊急通知
**[Optional]**
IF 獣医師が診療記録画面で「緊急連絡」フラグをONに設定した場合
THEN THE システム SHALL 3秒以内に飼い主の全登録デバイスへプッシュ通知を送信し、送信ステータスをログに記録する

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### REQ-NFR-001: レスポンス時間
**[Ubiquitous]**
THE システム SHALL 全てのAPI呼び出しに対して95パーセンタイルで2秒以内、99パーセンタイルで5秒以内にレスポンスを返却する

#### REQ-NFR-002: 同時接続
**[Ubiquitous]**
THE システム SHALL 100同時セッションの負荷下でREQ-NFR-001のレスポンス時間要件を維持する

### 3.2 セキュリティ

#### REQ-NFR-003: 認証
**[Ubiquitous]**
THE システム SHALL パスワード認証に加えてTOTPベースの二要素認証を提供し、管理者ロールには二要素認証を必須とする

#### REQ-NFR-004: データ暗号化
**[Ubiquitous]**
THE システム SHALL 個人情報（氏名・住所・電話番号）および医療データをAES-256で暗号化してデータベースに保存する

#### REQ-NFR-005: 不正アクセス防止
**[Unwanted]**
THE システム SHALL NOT 有効なJWTトークンを持たないリクエストに対して医療データを含むエンドポイントへのアクセスを許可する（HTTPステータス401を返却）

### 3.3 可用性

#### REQ-NFR-006: 稼働率
**[Ubiquitous]**
THE システム SHALL 月間稼働率99.5%以上（計画メンテナンス除く最大ダウンタイム3.6時間/月）を維持する

---

## 4. トレーサビリティマトリクス

| 要件ID | カテゴリ | EARSパターン | 優先度 | 測定可能性 |
|--------|----------|--------------|--------|------------|
| REQ-PET-001 | ペット管理 | Ubiquitous | P0 | ✅ |
| REQ-PET-002 | ペット管理 | Event-driven | P1 | ✅ |
| REQ-PET-003 | ペット管理 | State-driven | P0 | ✅ |
| REQ-RESERVE-001 | 予約管理 | Event-driven | P0 | ✅ |
| REQ-RESERVE-002 | 予約管理 | Event-driven | P1 | ✅ |
| REQ-RESERVE-003 | 予約管理 | Optional | P2 | ✅ |
| REQ-RESERVE-004 | 予約管理 | Unwanted | P0 | ✅ |
| REQ-VET-001 | スケジュール | Ubiquitous | P0 | ✅ |
| REQ-VET-002 | スケジュール | State-driven | P0 | ✅ |
| REQ-VET-003 | スケジュール | Event-driven | P1 | ✅ |
| REQ-MEDICAL-001 | 診療記録 | Event-driven | P0 | ✅ |
| REQ-MEDICAL-002 | 診療記録 | Ubiquitous | P0 | ✅ |
| REQ-MEDICAL-003 | 診療記録 | Event-driven | P1 | ✅ |
| REQ-NOTIFY-001 | 通知 | Event-driven | P1 | ✅ |
| REQ-NOTIFY-002 | 通知 | Event-driven | P1 | ✅ |
| REQ-NOTIFY-003 | 通知 | Optional | P2 | ✅ |
| REQ-NFR-001 | 非機能 | Ubiquitous | P0 | ✅ |
| REQ-NFR-002 | 非機能 | Ubiquitous | P1 | ✅ |
| REQ-NFR-003 | 非機能 | Ubiquitous | P0 | ✅ |
| REQ-NFR-004 | 非機能 | Ubiquitous | P0 | ✅ |
| REQ-NFR-005 | 非機能 | Unwanted | P0 | ✅ |
| REQ-NFR-006 | 非機能 | Ubiquitous | P1 | ✅ |

---

## 5. レビュー履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2026-01-04 | 初版作成 |
| 1.1.0 | 2026-01-04 | 全要件を具体化・測定可能な基準を追加 |
