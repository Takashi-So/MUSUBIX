---
name: session-manager
description: |
  MUSUBIXセッション管理スキル。セッション開始時に過去のコンテキストを復元し、
  終了時に状態を永続化する。TodoWrite統合によるマルチステップタスク追跡を提供。
  セッション間の継続性を確保し、コンテキスト圧縮前の状態保存も行う。
license: MIT
version: 1.0.0
author: MUSUBIX Team
tags:
  - session
  - persistence
  - context
  - todo
---

# Session Manager スキル

セッションの開始・終了時にコンテキストを管理し、作業の継続性を提供します。

## 概要

このスキルは以下の機能を提供します：

1. **セッション開始時のコンテキスト復元** - 過去7日間のセッションから継続可能なコンテキストを検索・通知
2. **セッション終了時の状態保存** - 完了タスク、進行中タスク、次回向けメモをMarkdown形式で保存
3. **コンテキスト圧縮前の状態保存** - 自動圧縮により重要なコンテキストが失われることを防止
4. **TodoWrite統合** - マルチステップタスクの進捗追跡と可視化

---

## セッション開始時の手順

新しいセッションを開始する際は、以下を実行してください：

### 1. 過去セッションの検索

```bash
# 過去7日間のセッションファイルを検索
find ~/.musubix/sessions/ -name "*.md" -mtime -7 -type f 2>/dev/null | head -5
```

### 2. 直近セッションの確認

直近のセッションファイルが見つかった場合：

1. 「Notes for Next Session」セクションを読み込む
2. 「Context to Load」に記載されたファイルを確認
3. 未完了タスク（In Progress）を確認

### 3. ユーザーへの通知

以下の形式で継続可能なコンテキストを通知：

```markdown
📋 **前回セッションからの引き継ぎ**

**日時**: [前回セッションの日時]

**未完了タスク**:
- [ ] タスク1
- [ ] タスク2

**次回向けメモ**:
- 重要なコンテキスト情報

**読み込み推奨ファイル**:
- `path/to/file1`
- `path/to/file2`

続きから作業を再開しますか？
```

---

## セッション終了時の手順

セッションを終了する際、または長時間の中断前に、以下を実行してください：

### 1. セッション状態の収集

現在のセッションから以下を収集：

- 完了したタスク
- 進行中のタスク
- 重要なコンテキスト情報
- 次回読み込むべきファイル

### 2. セッションファイルの保存

以下の形式で `~/.musubix/sessions/YYYY-MM-DD-HH-MM.md` に保存：

```markdown
# Session: [日付]

**Date:** [YYYY-MM-DD]
**Started:** [HH:MM]
**Last Updated:** [HH:MM]
**Project:** [プロジェクト名]

---

## Current State

### Completed
- [x] 完了したタスク1
- [x] 完了したタスク2

### In Progress
- [ ] 進行中のタスク1
- [ ] 進行中のタスク2

### Blocked
- [ ] ブロックされているタスク（理由: ...）

---

## Notes for Next Session

- 重要なコンテキスト情報1
- 重要なコンテキスト情報2
- 次回確認すべき事項

---

## Context to Load

```
relevant/files/to/load
another/important/file
```

---

## Session Summary

- **タスク完了数**: X
- **新規パターン学習**: Y
- **チェックポイント作成**: Z
```

### 3. 保存確認

セッションファイルが正常に保存されたことを確認し、ユーザーに通知：

```markdown
✅ セッションを保存しました: `~/.musubix/sessions/2026-01-25-14-30.md`

**サマリー**:
- 完了タスク: 5件
- 未完了タスク: 2件
- 次回向けメモ: 3項目
```

---

## コンテキスト圧縮前の保存

### トリガー条件

以下の条件でコンテキスト圧縮が検出された場合：

1. context-optimizerスキルからの圧縮提案
2. ツール呼び出し回数が閾値（50回）を超過
3. ユーザーによる明示的な圧縮リクエスト

### 保存手順

1. **現在の重要状態を特定**:
   - アクティブなタスクリスト
   - 直近の決定事項
   - 重要なファイルパス
   - 未解決の問題

2. **圧縮前スナップショットを作成**:

```markdown
## Pre-Compact Snapshot

**Timestamp:** [現在時刻]
**Tool Calls:** [呼び出し回数]

### Active Context
- 現在取り組んでいるタスク
- 関連ファイル

### Key Decisions
- 決定1: 理由
- 決定2: 理由

### Pending Issues
- 未解決の問題1
- 未解決の問題2
```

3. **セッションファイルに追記**

---

## TodoWrite統合

マルチステップタスクを実行する際は、必ずTodoWriteツールを使用してください。

### タスクリスト作成

複数ステップを含むタスクを開始する際：

1. **タスクを分解**:
   ```markdown
   ## タスク: [タスク名]
   
   - [ ] ステップ1: [詳細]
   - [ ] ステップ2: [詳細]
   - [ ] ステップ3: [詳細]
   ```

2. **TodoWriteで登録**:
   - 各ステップを個別のTodoとして登録
   - 依存関係がある場合は順序を明示

3. **進捗追跡**:
   - 完了したステップは即座にチェック
   - 問題が発生したステップはメモを追加

### 品質チェック

タスクリストを確認する際、以下を検証：

| チェック項目 | 確認内容 |
|-------------|----------|
| 実行順序 | ステップの順序が論理的か |
| 欠落ステップ | 必要なステップが抜けていないか |
| 粒度 | 各ステップが適切なサイズか |
| 要件との整合性 | ユーザー要件を正しく理解しているか |

### 問題検出時のアクション

- **順序の誤り**: 修正を提案し、ユーザーに確認
- **欠落ステップ**: 追加すべきステップを提示
- **粒度の問題**: 分割または統合を提案
- **要件の誤解**: 確認質問を実施

---

## MCPツール統合

このスキルは以下のMUSUBIX MCPツールと連携します：

### workflow-engine連携
- `workflow_get_status`: 現在のワークフローフェーズを取得
- `workflow_advance_phase`: 次フェーズへの遷移

### knowledge連携
- `knowledge_put_entity`: セッションエンティティの保存
- `knowledge_query`: 過去セッションの検索

### skill-manager連携
- `skill_execute`: 他スキルの呼び出し
- `skill_get_info`: スキル情報の取得

MCPツールが利用可能な場合は、それらを優先的に使用してください。

---

## ストレージ構造

```
~/.musubix/
├── sessions/
│   ├── 2026-01-25-14-30.md
│   ├── 2026-01-24-09-15.md
│   └── ...
├── checkpoints/
│   └── checkpoints.log
└── skills/
    └── learned/
        └── ...
```

### セッションファイル命名規則

`YYYY-MM-DD-HH-MM.md`

例: `2026-01-25-14-30.md`

### 保持ポリシー

- **保持期間**: 30日（自動削除）
- **最大ファイルサイズ**: 1MB/ファイル
- **最大ファイル数**: 100ファイル

---

## トラブルシューティング

### セッションファイルが見つからない

1. `~/.musubix/sessions/` ディレクトリの存在を確認
2. ディレクトリがない場合は作成: `mkdir -p ~/.musubix/sessions/`
3. 権限を確認: `ls -la ~/.musubix/`

### セッションの復元に失敗

1. ファイルの形式を確認（Markdownとして有効か）
2. 「Notes for Next Session」セクションの存在を確認
3. 手動でファイル内容を確認し、必要な情報を抽出

### TodoWriteとの同期エラー

1. TodoWriteツールの可用性を確認
2. タスクIDの重複がないか確認
3. 必要に応じてタスクリストを再作成

---

## 関連スキル

- **context-optimizer**: コンテキスト圧縮提案
- **learning-hooks**: セッション終了時のパターン抽出
- **checkpoint**: 状態スナップショット管理

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0.0 | 2026-01-25 | 初版リリース |

---

## 参考資料

- [REQ-SM-001〜004](../../storage/specs/REQ-v3.7.0-everything-claude-code-integration.md)
- [DES-v3.7.0 Section 4](../../storage/design/DES-v3.7.0-everything-claude-code-integration.md)
- [Agent Skills Open Standard](https://github.com/agentskills/agentskills)
