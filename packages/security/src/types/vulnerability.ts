/**
 * @fileoverview Vulnerability type definitions
 * @module @nahisaho/musubix-security/types/vulnerability
 * @trace REQ-SEC-SCAN-001, REQ-SEC-SCAN-002, REQ-SEC-SCAN-003
 */

/**
 * OWASP Top 10 (2021) vulnerability categories
 */
export type OWASPCategory =
  | 'A01:2021' // Broken Access Control
  | 'A02:2021' // Cryptographic Failures
  | 'A03:2021' // Injection
  | 'A04:2021' // Insecure Design
  | 'A05:2021' // Security Misconfiguration
  | 'A06:2021' // Vulnerable and Outdated Components
  | 'A07:2021' // Identification and Authentication Failures
  | 'A08:2021' // Software and Data Integrity Failures
  | 'A09:2021' // Security Logging and Monitoring Failures
  | 'A10:2021' // Server-Side Request Forgery
  | 'A00:Unknown'; // Unknown/Zero-day (Phase 2)

/**
 * Vulnerability type classification
 */
export type VulnerabilityType =
  | 'injection' // A03:2021 - SQL, NoSQL, OS, LDAP injection
  | 'xss' // A03:2021 - Cross-Site Scripting
  | 'broken-access' // A01:2021 - Broken Access Control
  | 'broken-auth' // A07:2021 - Authentication Failures
  | 'sensitive-exposure' // A02:2021 - Sensitive Data Exposure
  | 'xxe' // A05:2021 - XML External Entities (CWE-611)
  | 'misconfig' // A05:2021 - Security Misconfiguration
  | 'insecure-deser' // A08:2021 - Insecure Deserialization
  | 'insecure-deserialization' // CWE-502 - Insecure Deserialization (alias)
  | 'vuln-components' // A06:2021 - Vulnerable Components
  | 'insufficient-logging' // A09:2021 - Insufficient Logging
  | 'ssrf' // A10:2021 - Server-Side Request Forgery (CWE-918)
  | 'path-traversal' // CWE-22
  | 'command-injection' // CWE-78
  | 'code-injection' // CWE-94
  | 'open-redirect' // CWE-601
  | 'prototype-pollution' // CWE-1321
  | 'ldap-injection' // CWE-90 - LDAP Injection
  | 'redos' // CWE-1333 - ReDoS (Regular Expression Denial of Service)
  | 'race-condition' // CWE-362 - Race Condition / TOCTOU
  // Phase 2 additions
  | 'prompt-injection' // AI/LLM prompt injection
  | 'dependency' // Container/dependency vulnerability
  | 'configuration' // IaC misconfiguration
  | 'zero-day' // Unknown/zero-day vulnerability
  | 'data-flow'; // Interprocedural data flow vulnerability

/**
 * Severity levels for vulnerabilities
 */
export type Severity = 'critical' | 'high' | 'medium' | 'low' | 'info';

/**
 * Source code location
 * @trace DES-SEC-SCAN-001
 */
export interface SourceLocation {
  /** Absolute file path */
  file: string;
  /** Start line number (1-based) */
  startLine: number;
  /** End line number (1-based) */
  endLine: number;
  /** Start column number (0-based) */
  startColumn: number;
  /** End column number (0-based) */
  endColumn: number;
}

/**
 * Detected vulnerability
 * @trace REQ-SEC-SCAN-001
 */
export interface Vulnerability {
  /** Unique vulnerability ID (e.g., "VULN-2026-001") */
  id: string;
  /** Vulnerability type classification */
  type: VulnerabilityType;
  /** Severity level */
  severity: Severity;
  /** Related CWE identifiers */
  cwes: string[];
  /** Related OWASP categories */
  owasp?: OWASPCategory[];
  /** Source code location */
  location: SourceLocation;
  /** Human-readable description */
  description: string;
  /** Recommended fix */
  recommendation: string;
  /** Detection confidence (0.0 - 1.0) */
  confidence: number;
  /** Rule ID that detected this vulnerability */
  ruleId: string;
  /** Original vulnerable code snippet */
  codeSnippet?: string;
  /** Detection timestamp */
  detectedAt: Date;
}

/**
 * Scan options
 * @trace REQ-SEC-SCAN-004
 */
export interface ScanOptions {
  /** Filter by severity levels */
  severityFilter?: Severity[];
  /** Rulesets to use */
  rulesets?: ('owasp-top-10' | 'cwe-top-25' | 'custom')[];
  /** File patterns to exclude */
  excludePatterns?: string[];
  /** Maximum file size in bytes */
  maxFileSize?: number;
  /** Enable incremental scanning */
  incremental?: boolean;
  /** Custom rules directory */
  customRulesDir?: string;
}

/**
 * Scan result
 * @trace REQ-SEC-SCAN-001
 */
export interface ScanResult {
  /** Detected vulnerabilities */
  vulnerabilities: Vulnerability[];
  /** Number of files scanned */
  scannedFiles: number;
  /** Number of files skipped */
  skippedFiles: number;
  /** Scan duration in milliseconds */
  duration: number;
  /** Scan timestamp */
  timestamp: Date;
  /** Scan options used */
  options: ScanOptions;
  /** Summary by severity */
  summary: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    info: number;
    total: number;
  };
}

/**
 * Security rule definition
 */
export interface SecurityRule {
  /** Unique rule ID */
  id: string;
  /** Rule name */
  name: string;
  /** Rule description */
  description: string;
  /** Vulnerability type this rule detects */
  type: VulnerabilityType;
  /** Default severity */
  severity: Severity;
  /** Related CWEs */
  cwes: string[];
  /** Related OWASP categories */
  owasp?: OWASPCategory[];
  /** AST pattern to match (simplified) */
  pattern?: string;
  /** Detection function name */
  detector?: string;
  /** Whether rule is enabled by default */
  enabled: boolean;
  /** Rule metadata */
  metadata?: Record<string, unknown>;
}
